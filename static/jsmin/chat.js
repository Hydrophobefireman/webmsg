(async()=>{(new Image).src="/static/attachment.svg",(new Image).src="/static/close.svg",(new Image).src="/static/home.svg";const e={q:(e,t=!0)=>{const a=Array.from(document.querySelectorAll(e));return t?a[0]:a},id:e=>document.getElementById(e),className:(e,t=!0)=>{const a=Array.from(document.getElementsByClassName(e));return t?a[0]:a},create:e=>document.createElement(e),set:(e,t,a)=>e.setAttribute(t,a)},t=e.q("meta[name='chat_id']").content,a=e.q("meta[name='user_details']"),s=a.getAttribute("data-this"),n=a.getAttribute("data-that"),i=e.id("results-all");let o,c,l;async function d(a,i){async function o(t,a,n,i,o,c,l,d,r=null){let g;const h=e.create("div");if(n===s?(g="msg_sent",h.style.marginLeft="auto"):(g="msg_recieved",h.style.marginRight="auto"),e.set(h,"class",`msg ${g}`),r){e.set(h,"data-media",r);const t=new Image;t.src="/static/attachment.svg",h.appendChild(t),h.style.fontSize="12px",h.appendChild+="Media Message"}else e.set(h,"data-media",null),h.textContent=a;let u;e.set(h,"data-sender",n),e.set(h,"data-receiver",i),e.set(h,"data-stamp",o),e.set(h,"data-msgid",c),e.set(h,"data-read",l),e.set(h,"data-rstamp",d),t.appendChild(h),t.scrollTop=t.scrollHeight,h.onclick=function(){!function(t){const a=t.dataset,n=a.sender,i=parseInt(a.stamp),o=a.read,c=parseInt(a.rstamp),l=a.media,d=e.id("message-info");d.innerHTML="",d.style.opacity="1";const r=e.create("div");e.set(r,"class","message-close"),r.textContent="Close";const g=e.create("div");g.style.transition="0.3s ease-in-out",d.appendChild(r),d.appendChild(g),r.onclick=(()=>{g.style.opacity="0",g.style.height="0px",d.style.opacity="0",d.innerHTML=""});const h=e.create("div"),u=e.create("div"),y=e.create("div"),f=e.create("div"),w=e.create("div"),C=e.create("div");e.set(h,"class","message-info-key"),e.set(h,"data-slide","out"),e.set(u,"class","message-info-value"),e.set(y,"class","message-info-key"),e.set(y,"data-slide","out"),e.set(f,"class","message-info-value"),e.set(w,"class","message-info-key"),e.set(w,"data-slide","out"),e.set(C,"class","message-info-value"),h.onclick=(()=>{m(u),p(h)}),u.onclick=(()=>{m(h),p(u)}),y.onclick=(()=>{m(f),p(y)}),f.onclick=(()=>{m(y),p(f)}),w.onclick=(()=>{m(C),p(w)}),C.onclick=(()=>{m(w),p(C)}),h.textContent="Sender",u.textContent=n+(n===s?"(You)":""),w.textContent="Time",C.textContent=new Date(i).toLocaleString(),y.textContent="Read-Status",f.textContent="true"===o?`Read (${isNaN(c)?"N/A":new Date(c).toLocaleString()})`:"Sent",n!==s&&(y.style.display="none",f.style.display="none");if("null"!==l){const t=e.create("div"),a=e.create("div");e.set(t,"class","message-info-key"),e.set(a,"class","message-info-value"),t.textContent="Media Message",a.innerHTML="Click To Open Media Preview",a.style.cursor="pointer",e.set(a,"data-media",l),m(a),a.onclick=(()=>{const t=a.dataset,s=new Image;s.src=t.media,g.innerHTML="";const n=e.create("a");g.appendChild(s),g.appendChild(n),n.style.color="black",n.style.textDecoration="none",n.target="__blank",n.style.display="block",n.innerHTML="Click To Open Image In A New Tab",n.href=t.media,s.style.width="160px",s.style.height="100px"}),g.appendChild(t),g.appendChild(a)}d.style.display="block",g.appendChild(h),g.appendChild(u),g.appendChild(w),g.appendChild(C),g.appendChild(y),g.appendChild(f),console.log(a)}(this)},(u=await $get(e.__chatID__))?u[c]?console.log("[indexedDB]Cache HIT"):(console.log("[indexedDB]Adding new entry:",c),u[c]={message:a,sender:n,stamp:o,read:l,media:!!r||null,mediaURL:r,rstamp:d,receiver:i},await $set(e.__chatID__,u)):console.log("[indexedDB]Cache MISS")}const c=e.id("__chat-with-prof");if(i.typing)return c.style.color="green";if(c.style.color="#000",i.fetch){console.log("FETCHED DETAILS");const t=i.data;if(i.full_fetch)console.log("[indexedDB]Setting Full Cache to indexedDB:",t),await $set(e.__chatID__,t);else{const a=await $get(e.__chatID__),s=Object.assign({},a,t);await $set(e.__chatID__,s)}const s=i.fetched_from;for(let e=0;e<Object.keys(t).length;e++){let n;const i=t[n=isNaN(s)?e:e+s];i&&(i.msgid=n,d(a,i))}return}let l,r,g,h,u,f,w;if(i.media||i.message){if(i.sender!==s&&i.receiver!==s||i.sender!==n&&i.receiver!==n)throw console.log(i),new Error("Invalid Sender and recepient arguments");if(!i.read&&!i.rstamp&&i.sender!==s){const e={receiver:i.sender,sender:s,chat_id:t,message:null,read:{id:i.msgid},stamp:(new Date).getTime(),rstamp:(new Date).getTime()};await y(e)}}if(i.message)return l=i.message,r=i.sender,g=i.receiver,h=i.stamp,u=i.read,f=i.rstamp,o(a,l,r,g,h,w=i.msgid,u,f);if(i.update){const t=i.msgid,a=document.querySelector(`div[data-msgid='${t}']`);e.set(a,"data-read",i.update.read),e.set(a,"data-rstamp",i.update.rstamp)}if(i.media){const e=i.mediaURL;r=i.sender,g=i.receiver,u=i.read,f=i.rstamp,o(a,null,r,g,h=i.stamp,w=i.msgid,u,f,e)}}async function r(a){e.__chatID__=t,i.innerHTML="",i.style.display="block";const o=e.create("div"),c=e.create("div"),l=e.create("div"),d=e.create("div"),r=e.create("input"),g=e.create("img"),p=e.create("span"),m=e.create("div"),h=e.create("span"),u=e.create("div"),f=e.create("div");p.id="__chat-with-prof",e.set(m,"data-stat","closed"),e.set(p,"class","chat_with"),e.set(m,"class","menu-details"),e.set(h,"class","menubox"),e.set(r,"type","text"),e.set(r,"placeholder","Type a Message"),e.set(o,"class","chat_box_wrap"),e.set(c,"class","chat_box"),e.set(l,"class","chat_head"),e.set(d,"class","chat_body"),e.set(r,"class","chat_inp"),e.set(g,"class","context"),e.set(u,"class","img-button-holder"),e.set(f,"class","img-button-holder"),e.set(r,"data-user",a),d.id="_msg_body",m.appendChild(u),m.appendChild(f),l.appendChild(h),l.appendChild(p),c.appendChild(l),c.appendChild(m),c.appendChild(d),c.appendChild(r),c.appendChild(g),o.appendChild(c),h.innerHTML="&#9776;",p.textContent=a,i.appendChild(o),u.onclick=(()=>{window.location=`/u/${s}`}),u.textContent="Close Conversation",f.textContent="Add An Attachment",h.onclick=(()=>{if("closed"!=m.getAttribute("data-stat"))return e.set(m,"data-stat","closed"),m.style.marginBottom="-250px";e.set(m,"data-stat","opened"),m.style.marginBottom="0px"}),f.onclick=(()=>{const n=e.create("input");e.set(n,"accept","image/*"),e.set(n,"type","file"),h.click(),n.addEventListener("change",()=>{const e=n.files[0],i=new FileReader;i.onload=(n=>{const o=i.result,c=new Image;c.src=o,c.onload=(async()=>{const n=await async function(e,t,a){const s=document.createElement("canvas");if(void 0===e.naturalWidth&&void 0===e.naturalHeight)return console.log(e,"no natural width"),null;s.width=e.naturalWidth,s.height=e.naturalHeight,s.getContext("2d").drawImage(e,0,0);const n=s.toDataURL(a,t/100),i=await fetch(n);return await i.arrayBuffer()}(c,65,e.type),i=await fetch("/@/binary/",{credentials:"include",method:"post",headers:{"x-file-name":e.name},body:n}),o={media:(await i.json()).url,message:null,receiver:a,sender:s,chat_id:t,stamp:(new Date).getTime()};await y(o)})}),i.readAsDataURL(e)}),n.click()}),r.onkeydown=async function(e){if(13===e.keyCode&&this.value.replace(/\s/g,"").length>0){const e=(new Date).getTime(),a=r.value,i={sender:s,receiver:n,chat_id:t,message:a,typing:!1,media:null,stamp:e};r.value="";await y(i)}}}if(l=1e4,"function"==typeof window.Notification){try{console.log("Supports Notifications"),messaging=firebase.messaging(),await messaging.requestPermission(),messaging.usePublicVapidKey("BGhv7XYjPBkpVoOEPbq2E19Is1ti_MYfboTDazKE0jgxPENxDqe0-U2p1OKEEgG4JH4Ycl8Wbxdv-UrrP_LcLmw"),await messaging.getToken();const e=async()=>{const e=await messaging.getToken();console.log("Token refreshed."),console.log(e),await fetch("/@/notify/",{method:"post",headers:{"content-type":"application/x-www-form-urlencoded"},body:`token=${encodeURIComponent(e)}`})};await e(),messaging.onTokenRefresh(e)}catch(e){c=!0,console.log("Permission-Denied")}o=(t=>{const a=e.create("div"),n=e.create("div"),i=e.create("div"),o=e.create("div"),c=e.create("span"),l=e.create("input"),d=t.sender,g=t.message,p=t.hasImage,m=t.chat_id;if(e.set(l,"class","notification-reply-bar"),e.set(a,"class","notification-box"),e.set(n,"class","notification-sender"),e.set(i,"class","notification-text"),e.set(o,"class","notification-action-box"),e.set(c,"class","notification-action-button"),a.appendChild(n),a.appendChild(i),a.appendChild(o),o.appendChild(c),n.textContent=d,c.textContent=`Reply To ${d}`,p){const e=new Image;e.src="/static/attachment.svg",i.innerHTML="",i.appendChild(e)}else i.textContent=g;let h;document.body.appendChild(a),c.onclick=(()=>{clearTimeout(h),c.replaceWith(l),l.focus(),l.onkeydown=(e=>{if(13===e.keyCode&&l.value.replace(/\s/g,"").length>0){const e=(new Date).getTime(),t=l.value;y({receiver:d,message:t,media:null,stamp:e,sender:s,chat_id:m}),l.value="",a.remove()}})}),i.onclick=n.onclick=(()=>{r(d)}),setTimeout(()=>{a.style.marginTop="15px",h=setTimeout(()=>{a.remove()},4e3)},500)}),"granted"===Notification.permission?(console.log("Granted Notification Perm"),messaging.onMessage(e=>{const t=e.data;console.log("Creating Notification UI"),t.sender!==n&&o(t)})):c=!0}else c=!0;function g(){console.log(`[-] Manually Checking For Messages [Periodic Timer:${l}]`),async function(a=e.id("_msg_body")){const i=await $get(t);let o,c;if(i){const e=Object.keys(i).length;console.log("Checking For Updated Data"),o={stamp:(new Date).getTime(),message:null,sender:s,chat_id:t,receiver:n,fetch_messages:!0,fetch_from:e-1};for(let t=0;t<e;t++){const e=i[t];e&&(e.msgid=t,console.log(`Parsing msgid: ${t} from cache`),await d(a,e))}c=await y(o)}else console.log("Fetching New"),o={stamp:(new Date).getTime(),message:null,sender:s,chat_id:t,receiver:n,fetch_messages:!0},c=await y(o)}(),setTimeout(g,2e4)}function p(e){e.style.overflow="hidden",e.style.padding="0px",e.style.opacity=0,e.style.height="0",e.style.border="none",e.style.width="0"}function m(e){e.style.padding="5px",e.style.opacity=1,e.style.height="auto",e.style.width="auto",e.style.border="2px solid #e3e3e3",e.style.overflow="visible"}c&&(alert("We Cannot send notifications to you.This might cause messaging to slow down"),l=8e3);const h=`${"https:"===window.location.protocol?"wss://":"ws://"}${window.location.host}/@/messenger/`,u=new WebSocket(h);async function y(e,t="/@/messenger/"){let a;"object"==typeof e?a=JSON.stringify(e):"string"==typeof e&&(a=e),u.send(a)}console.log(u),u.onmessage=(t=>{const a=t.data;"pong"!==a&&function(t){const a=e.id("_msg_body");try{const e=JSON.parse(t);if(e.hasOwnProperty("error"))return console.log("prop-error",e),a.innerHTML+="<br>An error occured Please reload the page";d(a,e)}catch(e){console.log(e,"ERROR in parsing message"),a.innerHTML+="<br>An error occured Please reload the page"}}(a)}),u.onopen=(()=>{console.log("Opened Socket"),r(n),g(),function e(){u.readyState!==u.CLOSED&&u.readyState!==u.CLOSING&&u.send("ping"),console.log("keeping alive"),setTimeout(e,3e4)}()}),u.onclose=(()=>{e.id("_msg_body").innerHTML="<br>Connection to server was lost. Please Reload the page"})})();