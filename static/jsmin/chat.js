(async()=>{let e;(new Image).src="/static/attachment.svg",(new Image).src="/static/close.svg",(new Image).src="/static/home.svg",e=!0;const t={q:(e,t=!0)=>{const a=Array.from(document.querySelectorAll(e));return t?a[0]:a},id:e=>document.getElementById(e),className:(e,t=!0)=>{const a=Array.from(document.getElementsByClassName(e));return t?a[0]:a},create:e=>document.createElement(e),set:(e,t,a)=>e.setAttribute(t,a)},a=t.q("meta[name='chat_id']").content,s=t.q("meta[name='user_details']"),n=s.getAttribute("data-this"),i=s.getAttribute("data-that"),o=t.id("results-all");let c,l,d;async function r(e,s){async function o(e,a,s,i,o,c,l,d,r=null){let p;const g=t.create("div");if(s===n?(p="msg_sent",g.style.marginLeft="auto"):(p="msg_recieved",g.style.marginRight="auto"),t.set(g,"class",`msg ${p}`),r){t.set(g,"data-media",r);const e=new Image;e.src="/static/attachment.svg",g.appendChild(e),g.style.fontSize="12px",g.appendChild+="Media Message"}else t.set(g,"data-media",null),g.textContent=a;let u;t.set(g,"data-sender",s),t.set(g,"data-receiver",i),t.set(g,"data-stamp",o),t.set(g,"data-msgid",c),t.set(g,"data-read",l),t.set(g,"data-rstamp",d),e.appendChild(g),e.scrollTop=e.scrollHeight,g.onclick=function(){!function(e){const a=e.dataset,s=a.sender,i=parseInt(a.stamp),o=a.read,c=parseInt(a.rstamp),l=a.media,d=t.id("message-info");d.innerHTML="",d.style.opacity="1";const r=t.create("div");t.set(r,"class","message-close"),r.textContent="Close";const p=t.create("div");p.style.transition="0.3s ease-in-out",d.appendChild(r),d.appendChild(p),r.onclick=(()=>{p.style.opacity="0",p.style.height="0px",d.style.opacity="0",d.innerHTML=""});const g=t.create("div"),u=t.create("div"),y=t.create("div"),f=t.create("div"),w=t.create("div"),_=t.create("div");t.set(g,"class","message-info-key"),t.set(g,"data-slide","out"),t.set(u,"class","message-info-value"),t.set(y,"class","message-info-key"),t.set(y,"data-slide","out"),t.set(f,"class","message-info-value"),t.set(w,"class","message-info-key"),t.set(w,"data-slide","out"),t.set(_,"class","message-info-value"),g.onclick=(()=>{h(u),m(g)}),u.onclick=(()=>{h(g),m(u)}),y.onclick=(()=>{h(f),m(y)}),f.onclick=(()=>{h(y),m(f)}),w.onclick=(()=>{h(_),m(w)}),_.onclick=(()=>{h(w),m(_)}),g.textContent="Sender",u.textContent=s+(s===n?"(You)":""),w.textContent="Time",_.textContent=new Date(i).toLocaleString(),y.textContent="Read-Status",f.textContent="true"===o?`Read (${isNaN(c)?"N/A":new Date(c).toLocaleString()})`:"Sent",s!==n&&(y.style.display="none",f.style.display="none");if("null"!==l){const e=t.create("div"),a=t.create("div");t.set(e,"class","message-info-key"),t.set(a,"class","message-info-value"),e.textContent="Media Message",a.textContent="Click To Open Media Preview",a.style.cursor="pointer",t.set(a,"data-media",l),h(a),a.onclick=(()=>{const e=a.dataset,s=new Image;s.src=e.media,p.innerHTML="";const n=t.create("a");p.appendChild(s),p.appendChild(n),n.style.color="black",n.style.textDecoration="none",n.target="__blank",n.style.display="block",n.textContent="Click To Open Image In A New Tab",n.href=e.media,s.style.width="160px",s.style.height="100px"}),p.appendChild(e),p.appendChild(a)}d.style.display="block",p.appendChild(g),p.appendChild(u),p.appendChild(w),p.appendChild(_),p.appendChild(y),p.appendChild(f),console.log(a)}(this)},(u=await $get(t.__chatID__))&&(u[c]||(console.log("[indexedDB]Adding new entry:",c),u[c]={message:a,sender:s,stamp:o,read:l,media:!!r||null,mediaURL:r,rstamp:d,receiver:i},await $set(t.__chatID__,u)))}const c=t.id("__chat-with-prof");if(s.typing)return c.style.color="green";if(c.style.color="#000",s.fetch){console.log("FETCHED DETAILS");const a=s.data;if(s.full_fetch)console.log("[indexedDB]Setting Full Cache to indexedDB:",a),await $set(t.__chatID__,a);else{const e=await $get(t.__chatID__),s=Object.assign({},e,a);await $set(t.__chatID__,s)}const n=s.fetched_from;for(let t=0;t<Object.keys(a).length;t++){let s;const i=a[s=isNaN(n)?t:t+n];i&&(i.msgid=s,r(e,i))}return}let l,d,p,g,u,y,f;if(s.media||s.message){if(s.sender!==n&&s.receiver!==n||s.sender!==i&&s.receiver!==i)throw console.log(s),new Error("Invalid Sender and recepient arguments");if(!s.read&&!s.rstamp&&s.sender!==n){const e={receiver:s.sender,sender:n,chat_id:a,message:null,read:{id:s.msgid},stamp:(new Date).getTime(),rstamp:(new Date).getTime()};await w(e)}}if(s.message)return l=s.message,d=s.sender,p=s.receiver,g=s.stamp,u=s.read,y=s.rstamp,o(e,l,d,p,g,f=s.msgid,u,y);if(s.update){const e=s.msgid,n=document.querySelector(`div[data-msgid='${e}']`);t.set(n,"data-read",s.update.read),t.set(n,"data-rstamp",s.update.rstamp),console.log("updating data");const i=await $get(a),o=Object.assign({},i);o[e].read=s.update.read,o[e].rstamp=s.update.rstamp,await $set(a,o)}if(s.media){const t=s.mediaURL;d=s.sender,p=s.receiver,u=s.read,y=s.rstamp,o(e,null,d,p,g=s.stamp,f=s.msgid,u,y,t)}}async function p(e){t.__chatID__=a,o.innerHTML="",o.style.display="block";const s=t.create("div"),c=t.create("div"),l=t.create("div"),d=t.create("div"),r=t.create("input"),p=t.create("img"),g=t.create("span"),m=t.create("div"),h=t.create("span"),u=t.create("div"),y=t.create("div"),f=t.create("div");g.id="__chat-with-prof",t.set(m,"data-stat","closed"),t.set(g,"class","chat_with"),t.set(m,"class","menu-details"),m.id="__menubox__",t.set(h,"class","menubox"),t.set(r,"type","text"),t.set(r,"placeholder","Type a Message"),t.set(s,"class","chat_box_wrap"),t.set(c,"class","chat_box"),t.set(l,"class","chat_head"),t.set(d,"class","chat_body"),t.set(r,"class","chat_inp"),t.set(p,"class","context"),t.set(u,"class","img-button-holder"),t.set(f,"class","img-button-holder"),t.set(y,"class","img-button-holder"),t.set(r,"data-user",e),d.id="_msg_body",m.appendChild(u),m.appendChild(f),m.appendChild(y),l.appendChild(h),l.appendChild(g),c.appendChild(l),c.appendChild(m),c.appendChild(d),c.appendChild(r),c.appendChild(p),s.appendChild(c),h.innerHTML="&#9776;",g.textContent=e,y.textContent="Start WebRTC Session",o.appendChild(s),u.onclick=(()=>{window.location=`/u/${n}`}),h.id="Nzk3NzEzOD",u.textContent="Close Conversation",f.textContent="Add An Attachment",h.onclick=(()=>{if("closed"!=m.getAttribute("data-stat"))return t.set(m,"data-stat","closed"),m.style.marginBottom="-250px";t.set(m,"data-stat","opened"),m.style.marginBottom="0px"}),y.onclick=(async()=>{}),f.onclick=(()=>{const s=t.create("input");t.set(s,"accept","image/*"),t.set(s,"type","file"),h.click(),s.addEventListener("change",()=>{const t=s.files[0],i=new FileReader;i.onload=(s=>{const o=i.result,c=new Image;c.src=o,c.onload=(async()=>{const s=await async function(e,t,a){const s=document.createElement("canvas");if(void 0===e.naturalWidth&&void 0===e.naturalHeight)return console.log(e,"no natural width"),null;s.width=e.naturalWidth,s.height=e.naturalHeight,s.getContext("2d").drawImage(e,0,0);const n=s.toDataURL(a,t/100),i=await fetch(n);return await i.arrayBuffer()}(c,65,t.type),i=await fetch("/@/binary/",{credentials:"include",method:"post",headers:{"x-file-name":t.name},body:s}),o={media:(await i.json()).url,message:null,receiver:e,sender:n,chat_id:a,stamp:(new Date).getTime()};await w(o)})}),i.readAsDataURL(t)}),s.click()}),r.onkeydown=async function(e){if(13===e.keyCode&&this.value.replace(/\s/g,"").length>0){const e=(new Date).getTime(),t=r.value,s={sender:n,receiver:i,chat_id:a,message:t,typing:!1,media:null,stamp:e};r.value="";await w(s)}}}if(d=1e4,"function"==typeof window.Notification){try{console.log("Supports Notifications"),messaging=firebase.messaging(),await messaging.requestPermission(),messaging.usePublicVapidKey("BGhv7XYjPBkpVoOEPbq2E19Is1ti_MYfboTDazKE0jgxPENxDqe0-U2p1OKEEgG4JH4Ycl8Wbxdv-UrrP_LcLmw"),await messaging.getToken();const e=async()=>{const e=await messaging.getToken();console.log("Token refreshed."),console.log(e),await fetch("/@/notify/",{method:"post",headers:{"content-type":"application/x-www-form-urlencoded"},body:`token=${encodeURIComponent(e)}`})};await e(),messaging.onTokenRefresh(e)}catch(e){l=!0,console.log("Permission-Denied")}c=(e=>{const a=t.create("div"),s=t.create("div"),i=t.create("div"),o=t.create("div"),c=t.create("span"),l=t.create("input"),d=e.sender,r=e.message,p=e.hasImage,g=e.chat_id;if(t.set(l,"class","notification-reply-bar"),t.set(a,"class","notification-box"),t.set(s,"class","notification-sender"),t.set(i,"class","notification-text"),t.set(o,"class","notification-action-box"),t.set(c,"class","notification-action-button"),a.appendChild(s),a.appendChild(i),a.appendChild(o),o.appendChild(c),s.textContent=d,c.textContent=`Reply To ${d}`,p){const e=new Image;e.src="/static/attachment.svg",i.innerHTML="",i.appendChild(e)}else i.textContent=r;let m;document.body.appendChild(a),c.onclick=(()=>{clearTimeout(m),c.replaceWith(l),l.focus(),l.onkeydown=(e=>{if(13===e.keyCode&&l.value.replace(/\s/g,"").length>0){const e=(new Date).getTime(),t=l.value;w({receiver:d,message:t,media:null,stamp:e,sender:n,chat_id:g}),l.value="",a.remove()}})}),i.onclick=s.onclick=(()=>{window.location=`/chat/${g}`}),setTimeout(()=>{a.style.marginTop="15px",m=setTimeout(()=>{a.remove()},4e3)},500)}),"granted"===Notification.permission?(console.log("Granted Notification Perm"),messaging.onMessage(e=>{const t=e.data;console.log("Creating Notification UI"),t.sender!==i&&c(t)})):l=!0}else l=!0;async function g(){console.log(`[-] Manually Checking For Messages [Periodic Timer:${d}]`),await async function(s=t.id("_msg_body")){const o=await $get(a);let c;console.log("new template");const l=document.createElement("div");if(l.className="chat_body",o){const t=Object.keys(o).length;console.log("Checking For Updated Data"),c={stamp:(new Date).getTime(),message:null,sender:n,chat_id:a,receiver:i,fetch_messages:!0,fetch_from:t-1};for(let e=0;e<t;e++){const t=o[e];t&&(t.msgid=e,await r(l,t))}const d=s.scrollTop;s.replaceWith(l),l.scrollTop=e?l.scrollHeight:d,l.id="_msg_body",l.onclick=(()=>{f()}),s.remove(),_resp=await w(c)}else console.log("Fetching New"),c={stamp:(new Date).getTime(),message:null,sender:n,chat_id:a,receiver:i,fetch_messages:!0},_resp=await w(c)}(),setTimeout(await g,2e4)}function m(e){e.style.overflow="hidden",e.style.padding="0px",e.style.opacity=0,e.style.height="0",e.style.border="none",e.style.width="0"}function h(e){e.style.padding="5px",e.style.opacity=1,e.style.height="auto",e.style.width="auto",e.style.border="2px solid #e3e3e3",e.style.overflow="visible"}l&&(alert("We Cannot send notifications to you.This might cause messaging to slow down"),d=8e3);const u=`${"https:"===window.location.protocol?"wss://":"ws://"}${window.location.host}/@/messenger/`,y=new WebSocket(u);function f(){const e=t.id("Nzk3NzEzOD");"opened"===t.id("__menubox__").getAttribute("data-stat")&&e.click()}async function w(e,t="/@/messenger/"){let a;"object"==typeof e?a=JSON.stringify(e):"string"==typeof e&&(a=e),y.send(a)}console.log(y),y.onmessage=(e=>{const a=e.data;"pong"!==a&&function(e){const a=t.id("_msg_body");try{const t=JSON.parse(e);if(t.hasOwnProperty("error"))return console.log("prop-error",t),a.innerHTML+="<br>An error occured Please reload the page";r(a,t)}catch(e){console.log(e,"ERROR in parsing message"),a.innerHTML+="<br>An error occured Please reload the page"}}(a)}),y.onopen=(async()=>{console.log("Opened Socket"),p(i),await g(),e=!1,t.id("_msg_body").onclick=(()=>{f()}),function e(){y.readyState!==y.CLOSED&&y.readyState!==y.CLOSING&&y.send("ping"),console.log("keeping alive"),setTimeout(e,3e4)}()}),y.onclose=(()=>{t.id("_msg_body").innerHTML="<br>Connection to server was lost. Please Reload the page"})})();