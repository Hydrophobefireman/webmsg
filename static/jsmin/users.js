(async()=>{(new Image).src="/static/attachment.svg",(new Image).src="/static/close.svg";const e={id:e=>document.getElementById(e),className:(e,t=!0)=>{const s=Array.from(document.getElementsByClassName(e));return t?s[0]:s},create:e=>document.createElement(e),set:(e,t,s)=>e.setAttribute(t,s)},t=e.id("users"),s=e.id("sbm"),a=document.querySelector("meta[name='nonce']").getAttribute("content"),n=e.id("loading-gif"),i=e.id("messages"),o=e.id("results-all"),l=e.id("resbox-details"),d=e.id("res"),c=e.id("username_meta").getAttribute("content"),r=e.id("searchbox");async function p(t){const s=await fetch("/api/chatid/",{method:"POST",credentials:"include",body:m({side_a:c,side_b:t}),headers:{"content-type":"application/x-www-form-urlencoded"}});if(200!==s.status)return document.body.innerHTML="An error Occured..please reload the page";e.__chatID__=await s.text(),o.innerHTML="",d.style.display="none",r.style.display="none";const a=e.create("div"),n=e.create("div"),i=e.create("div"),l=e.create("div"),h=e.create("input"),y=e.create("img"),f=e.create("span"),w=e.create("div"),C=e.create("span"),v=e.create("img"),b=e.create("div"),k=e.create("div"),x=e.create("img");e.set(w,"data-stat","closed"),e.set(w,"class","menu-details"),e.set(C,"class","menubox"),e.set(h,"type","text"),e.set(h,"placeholder","Type a Message"),e.set(a,"class","chat_box_wrap"),e.set(n,"class","chat_box"),e.set(i,"class","chat_head"),e.set(l,"class","chat_body"),e.set(h,"class","chat_inp"),e.set(y,"class","context"),e.set(b,"class","img-button-holder"),e.set(k,"class","img-button-holder"),e.set(x,"title","Attach a File"),e.set(v,"title","Close this Chat"),e.set(h,"data-user",t),b.appendChild(v),k.appendChild(x),w.appendChild(b),w.appendChild(k),i.appendChild(C),i.appendChild(f),n.appendChild(i),n.appendChild(w),n.appendChild(l),n.appendChild(h),n.appendChild(y),a.appendChild(n),o.appendChild(a),v.onclick=(()=>{e.id("message-info").innerHTML="",e.id("message-info").style.opacity="0.0",o.innerHTML="",o.style.display="none",r.style.display="block",d.style.display="block"}),C.innerHTML="&#9776;",f.textContent=t,v.src="/static/close.svg",x.src="/static/attachment.svg",v.style.cursor="pointer",x.style.cursor="pointer";const _=`${("https:"===window.location.protocol?"wss://":"ws://")+window.location.host}/@/messenger/`,T=new WebSocket(_);function L(t,s){async function a(t,s,a,n,i,o,l,d,r=null){let p;const m=e.create("div");if(a===c?(p="msg_sent",m.style.marginLeft="auto"):(p="msg_recieved",m.style.marginRight="auto"),e.set(m,"class",`msg ${p}`),r){e.set(m,"data-media",r);const t=new Image;t.src="/static/attachment.svg",m.appendChild(t),m.style.fontSize="12px",m.appendChild+="Media Message"}else e.set(m,"data-media",null),m.textContent=s;let h;e.set(m,"data-sender",a),e.set(m,"data-receiver",n),e.set(m,"data-stamp",i),e.set(m,"data-msgid",o),e.set(m,"data-read",l),e.set(m,"data-rstamp",d),t.appendChild(m),t.scrollTop=t.scrollHeight,m.onclick=function(){!function(t){const s=t.dataset,a=s.sender,n=parseInt(s.stamp),i=s.read,o=parseInt(s.rstamp),l=s.media,d=e.id("message-info");d.innerHTML="",d.style.opacity="1";const r=e.create("div");e.set(r,"class","message-close"),r.innerHTML="Close";const p=e.create("div");p.style.transition="0.3s ease-in-out",d.appendChild(r),d.appendChild(p),r.onclick=(()=>{p.style.opacity="0",p.style.height="0px",d.style.opacity="0",d.innerHTML=""});const m=e.create("div"),h=e.create("div"),y=e.create("div"),f=e.create("div"),w=e.create("div"),C=e.create("div");if(e.set(m,"class","message-info-key"),e.set(m,"data-slide","out"),e.set(h,"class","message-info-value"),e.set(y,"class","message-info-key"),e.set(y,"data-slide","out"),e.set(f,"class","message-info-value"),e.set(w,"class","message-info-key"),e.set(w,"data-slide","out"),e.set(C,"class","message-info-value"),m.onclick=(()=>{u(h),g(m)}),h.onclick=(()=>{u(m),g(h)}),y.onclick=(()=>{u(f),g(y)}),f.onclick=(()=>{u(y),g(f)}),w.onclick=(()=>{u(C),g(w)}),C.onclick=(()=>{u(w),g(C)}),m.textContent="Sender",h.textContent=a+(a===c?"(You)":""),w.textContent="Time",C.textContent=new Date(n).toLocaleString(),y.textContent="Read-Status",f.textContent="true"===i?`Read (${isNaN(o)?"N/A":new Date(o).toLocaleString()})`:"Sent",a!==c&&(y.style.display="none",f.style.display="none"),"null"!==l){const t=e.create("div"),s=e.create("div");e.set(t,"class","message-info-key"),e.set(s,"class","message-info-value"),t.textContent="Media Message",s.innerHTML="Click To Open Media Preview",s.style.cursor="pointer",e.set(s,"data-media",l),u(s),s.onclick=(()=>{const t=s.dataset,a=new Image;a.src=t.media,p.innerHTML="";const n=e.create("a");p.appendChild(a),p.appendChild(n),n.style.color="black",n.style.textDecoration="none",n.target="__blank",n.style.display="block",n.innerHTML="Click To Open Image In A New Tab",n.href=t.media,a.style.width="160px",a.style.height="100px"}),p.appendChild(t),p.appendChild(s)}d.style.display="block",p.appendChild(m),p.appendChild(h),p.appendChild(w),p.appendChild(C),p.appendChild(y),p.appendChild(f),console.log(s)}(this)},(h=await $get(e.__chatID__))?(console.log("Cache HIT"),h[o]||(console.log("[indexedDB]Adding new entry:",o),h[o]={message:s,sender:a,stamp:i,read:l,media:!!r||null,mediaURL:r,rstamp:d,receiver:n},await $set(e.__chatID__,h))):console.log("[indexedDB]Cache MISS")}if(s.typing)return f.style.color="green";if(f.style.color="#fff",s.fetch){console.log("FETCHED DETAILS");const a=s.data;s.full_fetch&&(console.log("[indexedDB]Setting Full Cache to indexedDB:",a),$set(e.__chatID__,a));for(let e=0;e<Object.keys(a).length;e++){const s=a[e];s&&(s.msgid=e,L(t,s))}}let n,i,o,l,d,r,p;if((s.media||s.message)&&!s.read&&!s.rstamp&&s.sender!==c){const e={user:s.sender,message:null,read:{id:s.msgid},stamp:(new Date).getTime(),rstamp:(new Date).getTime()};T.send(JSON.stringify(e))}if(s.message)return n=s.message,i=s.sender,o=s.receiver,l=s.stamp,d=s.read,r=s.rstamp,a(t,n,i,o,l,p=s.msgid,d,r);if(s.update){const t=s.msgid,a=document.querySelector(`div[data-msgid='${t}']`);e.set(a,"data-read",s.update.read),e.set(a,"data-rstamp",s.update.rstamp)}if(s.media){const e=s.mediaURL;i=s.sender,o=s.receiver,d=s.read,r=s.rstamp,a(t,null,i,o,l=s.stamp,p=s.msgid,d,r,e)}}T.onmessage=(e=>{const t=e.data;try{const s=JSON.parse(t);if(s.hasOwnProperty("error"))return console.log("prop-error",s),l.innerHTML+="<br>An error occured Please reload the page";L(l,s)}catch(e){console.log(e,"ERR"),l.innerHTML+="<br>An error occured Please reload the page"}}),T.onopen=(()=>{!async function(t,s,a){const n=await $get(e.__chatID__);let i;if(console.log(n,"E"),n){const e=Object.keys(n).length;console.log("Checking For Updated Data"),i={stamp:(new Date).getTime(),message:null,user:s,fetch_messages:!0,fetch_from:e-1};for(let t=0;t<e;t++){const e=n[t];e&&(e.msgid=t,console.log(`Parsing msgid ${t}from cache`),L(a,e))}return t.send(JSON.stringify(i)),!0}console.log("Fetching New"),i={stamp:(new Date).getTime(),message:null,user:s,fetch_messages:!0},t.send(JSON.stringify(i))}(T,t,l),console.log("Socket Opened")}),T.onclose=(()=>{p(t),l.innerHTML+="<br>Connection to server was lost. Please Reload the page"}),x.onclick=(()=>{const s=e.create("input");e.set(s,"accept","image/*"),e.set(s,"type","file"),s.addEventListener("change",()=>{const e=s.files[0],a=new FileReader;a.onload=(s=>{const n=a.result,i=new Image;i.src=n,i.onload=(async()=>{const s=await async function(e,t,s){const a=document.createElement("canvas");if(void 0===e.naturalWidth&&void 0===e.naturalHeight)return console.log(e,"no natural width"),null;a.width=e.naturalWidth,a.height=e.naturalHeight,a.getContext("2d").drawImage(e,0,0);const n=a.toDataURL(s,t/100),i=await fetch(n);return await i.arrayBuffer()}(i,65,e.type),a=await fetch("/@/binary/",{credentials:"include",method:"post",headers:{"x-file-name":e.name},body:s}),n={media:(await a.json()).url,message:null,user:t,stamp:(new Date).getTime()};T.send(JSON.stringify(n))})}),a.readAsDataURL(e)}),s.click()}),C.onclick=(()=>{if("closed"!=w.getAttribute("data-stat"))return e.set(w,"data-stat","closed"),w.style.marginLeft="-100px";e.set(w,"data-stat","opened"),w.style.marginLeft="0px"}),h.onkeydown=function(e){if(13===e.keyCode&&h.value.replace(/\s/g,"").length>0){const e=(new Date).getTime(),t=h.value,s={user:this.getAttribute("data-user"),message:t,typing:!1,media:null,stamp:e};T.send(JSON.stringify(s)),h.value=""}}}n.oncontextmenu=(e=>{e.preventDefault()}),t.addEventListener("keydown",e=>{13===e.keyCode&&s.click()});const m=e=>`${Object.keys(e).map(t=>`${encodeURIComponent(t)}=${encodeURIComponent(e[t])}`).join("&")}`;function g(e){e.style.overflow="hidden",e.style.padding="0px",e.style.opacity=0,e.style.height="0",e.style.border="none",e.style.width="0"}function u(e){e.style.padding="5px",e.style.opacity=1,e.style.height="auto",e.style.width="auto",e.style.border="2px solid #e3e3e3",e.style.overflow="visible"}s.onclick=(async()=>{if(i.style.visibility="hidden",0!=t.value.length){l.style.display="block",n.style.display="inline";const s=await fetch(`/api/user-search/tokens/${a}`,{method:"get",credentials:"include"}),d=await s.text(),c=await fetch("/api/users/",{credentials:"include",method:"post",headers:{"content-type":"application/x-www-form-urlencoded"},body:m({token:d,user:t.value})});n.style.display="none",l.style.display="none";try{return function(t){const s=t.users;if(o.innerHTML="",o.style.display="block",0===s.length)return o.innerHTML="No Results Found";for(const t of s){const s=document.createElement("span"),a=document.createElement("button");a.innerHTML=t,s.appendChild(a),e.set(s,"data-result",t),a.className="resbtn",o.appendChild(s),s.onclick=function(){p(this.getAttribute("data-result"))}}}(await c.json())}catch(e){return console.warn(e),i.style.visibility="visible",i.innerHTML="An error occured on our end..please try again"}}})})();