(async()=>{const e=`${("https:"===window.location.protocol?"wss://":"ws://")+window.location.host}/@/messenger/`;if(window.Notification)try{const e=firebase.messaging();await e.requestPermission(),e.usePublicVapidKey("BGhv7XYjPBkpVoOEPbq2E19Is1ti_MYfboTDazKE0jgxPENxDqe0-U2p1OKEEgG4JH4Ycl8Wbxdv-UrrP_LcLmw"),await e.getToken();const t=async()=>{const t=await e.getToken();console.log("Token refreshed."),console.log(t),await fetch("/@/notify/",{method:"post",headers:{"content-type":"application/x-www-form-urlencoded"},body:`token=${encodeURIComponent(t)}`})};await t(),e.onTokenRefresh(t)}catch(e){console.log("Permission-Denied")}let t;(new Image).src="/static/attachment.svg",(new Image).src="/static/close.svg";const s={id:e=>document.getElementById(e),className:(e,t=!0)=>{const s=Array.from(document.getElementsByClassName(e));return t?s[0]:s},create:e=>document.createElement(e),set:(e,t,s)=>e.setAttribute(t,s)},a=s.id("users"),n=s.id("sbm"),i=document.querySelector("meta[name='nonce']").getAttribute("content"),o=s.id("loading-gif"),c=s.id("messages"),l=s.id("results-all"),d=s.id("resbox-details"),r=s.id("res"),p=s.id("username_meta").getAttribute("content"),m=s.id("searchbox");if(o.oncontextmenu=(e=>{e.preventDefault()}),a.addEventListener("keydown",e=>{13===e.keyCode&&n.click()}),window.Notification){function g(t,a=new WebSocket(e)){const n=s.create("div"),i=s.create("div"),o=s.create("div"),c=s.create("div"),l=s.create("span"),d=s.create("span"),r=s.create("input"),p=t.sender,m=t.messageContent,g=t.hasImage;if(s.set(r,"class","notification-reply-bar"),s.set(n,"class","notification-box"),s.set(i,"class","notification-sender"),s.set(o,"class","notification-text"),s.set(c,"class","notification-action-box"),s.set(l,"class","notification-action-button"),s.set(d,"class","notification-action-button"),n.appendChild(i),n.appendChild(o),n.appendChild(c),c.appendChild(l),c.appendChild(d),i.textContent=p,l.textContent=`Reply To ${p}`,d.textContent="Mark As Read",g){const e=new Image;e.src="/static/attachment.svg",o.innerHTML="",o.appendChild(e)}else o.textContent=m;let h;document.body.appendChild(n),l.onclick=(()=>{clearTimeout(h),l.replaceWith(r),r.onkeydown=(e=>{if(13===e.keyCode&&r.value.replace(/\s/g,"").length>0){const e=(new Date).getTime(),t=r.value,s={user:p,message:t,typing:!1,media:null,stamp:e};a.send(JSON.stringify(s)),r.value="",n.remove()}})}),d.onclick=(()=>{const e={user:p,message:null,read:{id:t.msgid},stamp:(new Date).getTime(),rstamp:(new Date).getTime()};a.send(JSON.stringify(e)),n.remove()}),o.onclick=i.onclick=(()=>{u(p)}),setTimeout(()=>{n.style.marginTop="15px",h=setTimeout(()=>{n.remove()},4e3)},500)}"granted"===Notification.permission&&(console.log("Granted Notification Perm"),messaging.onMessage(e=>{const s=e.data;console.log("Creating Notification UI"),"function"==typeof t?s.sender!==t()&&g(s):g(s)}))}async function u(a){t=(()=>a);const n=await fetch("/api/chatid/",{method:"POST",credentials:"include",body:h({side_a:p,side_b:a}),headers:{"content-type":"application/x-www-form-urlencoded"}});if(200!==n.status)return document.body.innerHTML="An error Occured..please reload the page";s.__chatID__=await n.text(),l.innerHTML="",r.style.display="none",m.style.display="none";const i=s.create("div"),o=s.create("div"),c=s.create("div"),d=s.create("div"),g=s.create("input"),w=s.create("img"),C=s.create("span"),v=s.create("div"),b=s.create("span"),k=s.create("img"),x=s.create("div"),T=s.create("div"),_=s.create("img");s.set(v,"data-stat","closed"),s.set(v,"class","menu-details"),s.set(b,"class","menubox"),s.set(g,"type","text"),s.set(g,"placeholder","Type a Message"),s.set(i,"class","chat_box_wrap"),s.set(o,"class","chat_box"),s.set(c,"class","chat_head"),s.set(d,"class","chat_body"),s.set(g,"class","chat_inp"),s.set(w,"class","context"),s.set(x,"class","img-button-holder"),s.set(T,"class","img-button-holder"),s.set(_,"title","Attach a File"),s.set(k,"title","Close this Chat"),s.set(g,"data-user",a),x.appendChild(k),T.appendChild(_),v.appendChild(x),v.appendChild(T),c.appendChild(b),c.appendChild(C),o.appendChild(c),o.appendChild(v),o.appendChild(d),o.appendChild(g),o.appendChild(w),i.appendChild(o),l.appendChild(i),k.onclick=(()=>{s.id("message-info").innerHTML="",s.id("message-info").style.opacity="0.0",l.innerHTML="",l.style.display="none",m.style.display="block",r.style.display="block"}),b.innerHTML="&#9776;",C.textContent=a,k.src="/static/close.svg",_.src="/static/attachment.svg",k.style.cursor="pointer",_.style.cursor="pointer";const L=new WebSocket(e);async function D(e,t){async function a(e,t,a,n,i,o,c,l,d=null){let r;const m=s.create("div");if(a===p?(r="msg_sent",m.style.marginLeft="auto"):(r="msg_recieved",m.style.marginRight="auto"),s.set(m,"class",`msg ${r}`),d){s.set(m,"data-media",d);const e=new Image;e.src="/static/attachment.svg",m.appendChild(e),m.style.fontSize="12px",m.appendChild+="Media Message"}else s.set(m,"data-media",null),m.textContent=t;let g;s.set(m,"data-sender",a),s.set(m,"data-receiver",n),s.set(m,"data-stamp",i),s.set(m,"data-msgid",o),s.set(m,"data-read",c),s.set(m,"data-rstamp",l),e.appendChild(m),e.scrollTop=e.scrollHeight,m.onclick=function(){!function(e){const t=e.dataset,a=t.sender,n=parseInt(t.stamp),i=t.read,o=parseInt(t.rstamp),c=t.media,l=s.id("message-info");l.innerHTML="",l.style.opacity="1";const d=s.create("div");s.set(d,"class","message-close"),d.innerHTML="Close";const r=s.create("div");r.style.transition="0.3s ease-in-out",l.appendChild(d),l.appendChild(r),d.onclick=(()=>{r.style.opacity="0",r.style.height="0px",l.style.opacity="0",l.innerHTML=""});const m=s.create("div"),g=s.create("div"),u=s.create("div"),h=s.create("div"),w=s.create("div"),C=s.create("div");if(s.set(m,"class","message-info-key"),s.set(m,"data-slide","out"),s.set(g,"class","message-info-value"),s.set(u,"class","message-info-key"),s.set(u,"data-slide","out"),s.set(h,"class","message-info-value"),s.set(w,"class","message-info-key"),s.set(w,"data-slide","out"),s.set(C,"class","message-info-value"),m.onclick=(()=>{f(g),y(m)}),g.onclick=(()=>{f(m),y(g)}),u.onclick=(()=>{f(h),y(u)}),h.onclick=(()=>{f(u),y(h)}),w.onclick=(()=>{f(C),y(w)}),C.onclick=(()=>{f(w),y(C)}),m.textContent="Sender",g.textContent=a+(a===p?"(You)":""),w.textContent="Time",C.textContent=new Date(n).toLocaleString(),u.textContent="Read-Status",h.textContent="true"===i?`Read (${isNaN(o)?"N/A":new Date(o).toLocaleString()})`:"Sent",a!==p&&(u.style.display="none",h.style.display="none"),"null"!==c){const e=s.create("div"),t=s.create("div");s.set(e,"class","message-info-key"),s.set(t,"class","message-info-value"),e.textContent="Media Message",t.innerHTML="Click To Open Media Preview",t.style.cursor="pointer",s.set(t,"data-media",c),f(t),t.onclick=(()=>{const e=t.dataset,a=new Image;a.src=e.media,r.innerHTML="";const n=s.create("a");r.appendChild(a),r.appendChild(n),n.style.color="black",n.style.textDecoration="none",n.target="__blank",n.style.display="block",n.innerHTML="Click To Open Image In A New Tab",n.href=e.media,a.style.width="160px",a.style.height="100px"}),r.appendChild(e),r.appendChild(t)}l.style.display="block",r.appendChild(m),r.appendChild(g),r.appendChild(w),r.appendChild(C),r.appendChild(u),r.appendChild(h),console.log(t)}(this)},(g=await $get(s.__chatID__))?(console.log("Cache HIT"),g[o]||(console.log("[indexedDB]Adding new entry:",o),g[o]={message:t,sender:a,stamp:i,read:c,media:!!d||null,mediaURL:d,rstamp:l,receiver:n},await $set(s.__chatID__,g))):console.log("[indexedDB]Cache MISS")}if(t.typing)return C.style.color="green";if(C.style.color="#fff",t.fetch){console.log("FETCHED DETAILS");const a=t.data;if(t.full_fetch)console.log("[indexedDB]Setting Full Cache to indexedDB:",a),await $set(s.__chatID__,a);else{const e=await $get(s.__chatID__),t=Object.assign({},e,a);await $set(s.__chatID__,t)}const n=t.fetched_from;for(let t=0;t<Object.keys(a).length;t++){let s;const i=a[s=isNaN(n)?t:t+n];i&&(i.msgid=s,D(e,i))}}let n,i,o,c,l,d,r;if((t.media||t.message)&&!t.read&&!t.rstamp&&t.sender!==p){const e={user:t.sender,message:null,read:{id:t.msgid},stamp:(new Date).getTime(),rstamp:(new Date).getTime()};L.send(JSON.stringify(e))}if(t.message)return n=t.message,i=t.sender,o=t.receiver,c=t.stamp,l=t.read,d=t.rstamp,a(e,n,i,o,c,r=t.msgid,l,d);if(t.update){const e=t.msgid,a=document.querySelector(`div[data-msgid='${e}']`);s.set(a,"data-read",t.update.read),s.set(a,"data-rstamp",t.update.rstamp)}if(t.media){const s=t.mediaURL;i=t.sender,o=t.receiver,l=t.read,d=t.rstamp,a(e,null,i,o,c=t.stamp,r=t.msgid,l,d,s)}}L.onmessage=(e=>{const t=e.data;try{const s=JSON.parse(t);if(s.hasOwnProperty("error"))return console.log("prop-error",s),d.innerHTML+="<br>An error occured Please reload the page";D(d,s)}catch(e){console.log(e,"ERROR in parsing message"),d.innerHTML+="<br>An error occured Please reload the page"}}),L.onopen=(()=>{!async function(e,t,a){const n=await $get(s.__chatID__);let i;if(n){const s=Object.keys(n).length;console.log("Checking For Updated Data"),i={stamp:(new Date).getTime(),message:null,user:t,fetch_messages:!0,fetch_from:s-1};for(let e=0;e<s;e++){const t=n[e];t&&(t.msgid=e,console.log(`Parsing msgid: ${e} from cache`),D(a,t))}return e.send(JSON.stringify(i)),!0}console.log("Fetching New"),i={stamp:(new Date).getTime(),message:null,user:t,fetch_messages:!0},e.send(JSON.stringify(i))}(L,a,d),console.log("Socket Opened")}),L.onclose=(()=>{u(t()),d.innerHTML+="<br>Connection to server was lost. Please Reload the page"}),_.onclick=(()=>{const e=s.create("input");s.set(e,"accept","image/*"),s.set(e,"type","file"),e.addEventListener("change",()=>{const t=e.files[0],s=new FileReader;s.onload=(e=>{const n=s.result,i=new Image;i.src=n,i.onload=(async()=>{const e=await async function(e,t,s){const a=document.createElement("canvas");if(void 0===e.naturalWidth&&void 0===e.naturalHeight)return console.log(e,"no natural width"),null;a.width=e.naturalWidth,a.height=e.naturalHeight,a.getContext("2d").drawImage(e,0,0);const n=a.toDataURL(s,t/100),i=await fetch(n);return await i.arrayBuffer()}(i,65,t.type),s=await fetch("/@/binary/",{credentials:"include",method:"post",headers:{"x-file-name":t.name},body:e}),n={media:(await s.json()).url,message:null,user:a,stamp:(new Date).getTime()};L.send(JSON.stringify(n))})}),s.readAsDataURL(t)}),e.click()}),b.onclick=(()=>{if("closed"!=v.getAttribute("data-stat"))return s.set(v,"data-stat","closed"),v.style.marginLeft="-100px";s.set(v,"data-stat","opened"),v.style.marginLeft="0px"}),g.onkeydown=function(e){if(13===e.keyCode&&this.value.replace(/\s/g,"").length>0){const e=(new Date).getTime(),t=g.value,s={user:this.getAttribute("data-user"),message:t,typing:!1,media:null,stamp:e};L.send(JSON.stringify(s)),g.value=""}}}const h=e=>`${Object.keys(e).map(t=>`${encodeURIComponent(t)}=${encodeURIComponent(e[t])}`).join("&")}`;function y(e){e.style.overflow="hidden",e.style.padding="0px",e.style.opacity=0,e.style.height="0",e.style.border="none",e.style.width="0"}function f(e){e.style.padding="5px",e.style.opacity=1,e.style.height="auto",e.style.width="auto",e.style.border="2px solid #e3e3e3",e.style.overflow="visible"}n.onclick=(async()=>{if(c.style.visibility="hidden",0!=a.value.length){d.style.display="block",o.style.display="inline";const e=await fetch(`/api/user-search/tokens/${i}`,{method:"get",credentials:"include"}),t=await e.text(),n=await fetch("/api/users/",{credentials:"include",method:"post",headers:{"content-type":"application/x-www-form-urlencoded"},body:h({token:t,user:a.value})});o.style.display="none",d.style.display="none";try{return function(e){const t=e.users;if(l.innerHTML="",l.style.display="block",0===t.length)return l.innerHTML="No Results Found";for(const e of t){const t=document.createElement("span"),a=document.createElement("button");a.innerHTML=e,t.appendChild(a),s.set(t,"data-result",e),a.className="resbtn",l.appendChild(t),t.onclick=function(){u(this.getAttribute("data-result"))}}}(await n.json())}catch(e){return console.warn(e),c.style.visibility="visible",c.innerHTML="An error occured on our end..please try again"}}})})();