(async()=>{window.onerror=function(e){alert(e)};const e=firebase.messaging(),t=`${("https:"===window.location.protocol?"wss://":"ws://")+window.location.host}/@/messenger/`;try{await e.requestPermission(),e.usePublicVapidKey("BGhv7XYjPBkpVoOEPbq2E19Is1ti_MYfboTDazKE0jgxPENxDqe0-U2p1OKEEgG4JH4Ycl8Wbxdv-UrrP_LcLmw"),await e.getToken();const t=async()=>{const t=await e.getToken();console.log("Token refreshed."),console.log(t),await fetch("/@/notify/",{method:"post",headers:{"content-type":"application/x-www-form-urlencoded"},body:`token=${encodeURIComponent(t)}`})};await t(),e.onTokenRefresh(t)}catch(e){console.log("Permission-Denied")}let s;(new Image).src="/static/attachment.svg",(new Image).src="/static/close.svg";const a={id:e=>document.getElementById(e),className:(e,t=!0)=>{const s=Array.from(document.getElementsByClassName(e));return t?s[0]:s},create:e=>document.createElement(e),set:(e,t,s)=>e.setAttribute(t,s)},n=a.id("users"),i=a.id("sbm"),o=document.querySelector("meta[name='nonce']").getAttribute("content"),c=a.id("loading-gif"),l=a.id("messages"),d=a.id("results-all"),r=a.id("resbox-details"),p=a.id("res"),m=a.id("username_meta").getAttribute("content"),g=a.id("searchbox");function u(e,s=new WebSocket(t)){const n=a.create("div"),i=a.create("div"),o=a.create("div"),c=a.create("div"),l=a.create("span"),d=a.create("span"),r=a.create("input"),p=e.sender,m=e.messageContent,g=e.hasImage;if(a.set(r,"class","notification-reply-bar"),a.set(n,"class","notification-box"),a.set(i,"class","notification-sender"),a.set(o,"class","notification-text"),a.set(c,"class","notification-action-box"),a.set(l,"class","notification-action-button"),a.set(d,"class","notification-action-button"),n.appendChild(i),n.appendChild(o),n.appendChild(c),c.appendChild(l),c.appendChild(d),i.textContent=p,l.textContent=`Reply To ${p}`,d.textContent="Mark As Read",g){const e=new Image;e.src="/static/attachment.svg",o.innerHTML="",o.appendChild(e)}else o.textContent=m;let u;document.body.appendChild(n),l.onclick=(()=>{clearTimeout(u),l.replaceWith(r),r.onkeydown=(e=>{if(13===e.keyCode&&r.value.replace(/\s/g,"").length>0){const e=(new Date).getTime(),t=r.value,a={user:p,message:t,typing:!1,media:null,stamp:e};s.send(JSON.stringify(a)),r.value="",n.remove()}})}),d.onclick=(()=>{const t={user:p,message:null,read:{id:e.msgid},stamp:(new Date).getTime(),rstamp:(new Date).getTime()};s.send(JSON.stringify(t)),n.remove()}),o.onclick=i.onclick=(()=>{h(p)}),setTimeout(()=>{n.style.marginTop="15px",u=setTimeout(()=>{n.remove()},4e3)},500)}async function h(e){s=(()=>e);const n=await fetch("/api/chatid/",{method:"POST",credentials:"include",body:y({side_a:m,side_b:e}),headers:{"content-type":"application/x-www-form-urlencoded"}});if(200!==n.status)return document.body.innerHTML="An error Occured..please reload the page";a.__chatID__=await n.text(),d.innerHTML="",p.style.display="none",g.style.display="none";const i=a.create("div"),o=a.create("div"),c=a.create("div"),l=a.create("div"),r=a.create("input"),u=a.create("img"),C=a.create("span"),v=a.create("div"),b=a.create("span"),k=a.create("img"),x=a.create("div"),T=a.create("div"),_=a.create("img");a.set(v,"data-stat","closed"),a.set(v,"class","menu-details"),a.set(b,"class","menubox"),a.set(r,"type","text"),a.set(r,"placeholder","Type a Message"),a.set(i,"class","chat_box_wrap"),a.set(o,"class","chat_box"),a.set(c,"class","chat_head"),a.set(l,"class","chat_body"),a.set(r,"class","chat_inp"),a.set(u,"class","context"),a.set(x,"class","img-button-holder"),a.set(T,"class","img-button-holder"),a.set(_,"title","Attach a File"),a.set(k,"title","Close this Chat"),a.set(r,"data-user",e),x.appendChild(k),T.appendChild(_),v.appendChild(x),v.appendChild(T),c.appendChild(b),c.appendChild(C),o.appendChild(c),o.appendChild(v),o.appendChild(l),o.appendChild(r),o.appendChild(u),i.appendChild(o),d.appendChild(i),k.onclick=(()=>{a.id("message-info").innerHTML="",a.id("message-info").style.opacity="0.0",d.innerHTML="",d.style.display="none",g.style.display="block",p.style.display="block"}),b.innerHTML="&#9776;",C.textContent=e,k.src="/static/close.svg",_.src="/static/attachment.svg",k.style.cursor="pointer",_.style.cursor="pointer";const L=new WebSocket(t);async function D(e,t){async function s(e,t,s,n,i,o,c,l,d=null){let r;const p=a.create("div");if(s===m?(r="msg_sent",p.style.marginLeft="auto"):(r="msg_recieved",p.style.marginRight="auto"),a.set(p,"class",`msg ${r}`),d){a.set(p,"data-media",d);const e=new Image;e.src="/static/attachment.svg",p.appendChild(e),p.style.fontSize="12px",p.appendChild+="Media Message"}else a.set(p,"data-media",null),p.textContent=t;let g;a.set(p,"data-sender",s),a.set(p,"data-receiver",n),a.set(p,"data-stamp",i),a.set(p,"data-msgid",o),a.set(p,"data-read",c),a.set(p,"data-rstamp",l),e.appendChild(p),e.scrollTop=e.scrollHeight,p.onclick=function(){!function(e){const t=e.dataset,s=t.sender,n=parseInt(t.stamp),i=t.read,o=parseInt(t.rstamp),c=t.media,l=a.id("message-info");l.innerHTML="",l.style.opacity="1";const d=a.create("div");a.set(d,"class","message-close"),d.innerHTML="Close";const r=a.create("div");r.style.transition="0.3s ease-in-out",l.appendChild(d),l.appendChild(r),d.onclick=(()=>{r.style.opacity="0",r.style.height="0px",l.style.opacity="0",l.innerHTML=""});const p=a.create("div"),g=a.create("div"),u=a.create("div"),h=a.create("div"),y=a.create("div"),C=a.create("div");if(a.set(p,"class","message-info-key"),a.set(p,"data-slide","out"),a.set(g,"class","message-info-value"),a.set(u,"class","message-info-key"),a.set(u,"data-slide","out"),a.set(h,"class","message-info-value"),a.set(y,"class","message-info-key"),a.set(y,"data-slide","out"),a.set(C,"class","message-info-value"),p.onclick=(()=>{w(g),f(p)}),g.onclick=(()=>{w(p),f(g)}),u.onclick=(()=>{w(h),f(u)}),h.onclick=(()=>{w(u),f(h)}),y.onclick=(()=>{w(C),f(y)}),C.onclick=(()=>{w(y),f(C)}),p.textContent="Sender",g.textContent=s+(s===m?"(You)":""),y.textContent="Time",C.textContent=new Date(n).toLocaleString(),u.textContent="Read-Status",h.textContent="true"===i?`Read (${isNaN(o)?"N/A":new Date(o).toLocaleString()})`:"Sent",s!==m&&(u.style.display="none",h.style.display="none"),"null"!==c){const e=a.create("div"),t=a.create("div");a.set(e,"class","message-info-key"),a.set(t,"class","message-info-value"),e.textContent="Media Message",t.innerHTML="Click To Open Media Preview",t.style.cursor="pointer",a.set(t,"data-media",c),w(t),t.onclick=(()=>{const e=t.dataset,s=new Image;s.src=e.media,r.innerHTML="";const n=a.create("a");r.appendChild(s),r.appendChild(n),n.style.color="black",n.style.textDecoration="none",n.target="__blank",n.style.display="block",n.innerHTML="Click To Open Image In A New Tab",n.href=e.media,s.style.width="160px",s.style.height="100px"}),r.appendChild(e),r.appendChild(t)}l.style.display="block",r.appendChild(p),r.appendChild(g),r.appendChild(y),r.appendChild(C),r.appendChild(u),r.appendChild(h),console.log(t)}(this)},(g=await $get(a.__chatID__))?(console.log("Cache HIT"),g[o]||(console.log("[indexedDB]Adding new entry:",o),g[o]={message:t,sender:s,stamp:i,read:c,media:!!d||null,mediaURL:d,rstamp:l,receiver:n},await $set(a.__chatID__,g))):console.log("[indexedDB]Cache MISS")}if(t.typing)return C.style.color="green";if(C.style.color="#fff",t.fetch){console.log("FETCHED DETAILS");const s=t.data;if(t.full_fetch)console.log("[indexedDB]Setting Full Cache to indexedDB:",s),await $set(a.__chatID__,s);else{const e=await $get(a.__chatID__),t=Object.assign({},e,s);await $set(a.__chatID__,t)}const n=t.fetched_from;for(let t=0;t<Object.keys(s).length;t++){let a;const i=s[a=isNaN(n)?t:t+n];i&&(i.msgid=a,D(e,i))}}let n,i,o,c,l,d,r;if((t.media||t.message)&&!t.read&&!t.rstamp&&t.sender!==m){const e={user:t.sender,message:null,read:{id:t.msgid},stamp:(new Date).getTime(),rstamp:(new Date).getTime()};L.send(JSON.stringify(e))}if(t.message)return n=t.message,i=t.sender,o=t.receiver,c=t.stamp,l=t.read,d=t.rstamp,s(e,n,i,o,c,r=t.msgid,l,d);if(t.update){const e=t.msgid,s=document.querySelector(`div[data-msgid='${e}']`);a.set(s,"data-read",t.update.read),a.set(s,"data-rstamp",t.update.rstamp)}if(t.media){const a=t.mediaURL;i=t.sender,o=t.receiver,l=t.read,d=t.rstamp,s(e,null,i,o,c=t.stamp,r=t.msgid,l,d,a)}}L.onmessage=(e=>{const t=e.data;try{const s=JSON.parse(t);if(s.hasOwnProperty("error"))return console.log("prop-error",s),l.innerHTML+="<br>An error occured Please reload the page";D(l,s)}catch(e){console.log(e,"ERROR in parsing message"),l.innerHTML+="<br>An error occured Please reload the page"}}),L.onopen=(()=>{!async function(e,t,s){const n=await $get(a.__chatID__);let i;if(n){const a=Object.keys(n).length;console.log("Checking For Updated Data"),i={stamp:(new Date).getTime(),message:null,user:t,fetch_messages:!0,fetch_from:a-1};for(let e=0;e<a;e++){const t=n[e];t&&(t.msgid=e,console.log(`Parsing msgid: ${e} from cache`),D(s,t))}return e.send(JSON.stringify(i)),!0}console.log("Fetching New"),i={stamp:(new Date).getTime(),message:null,user:t,fetch_messages:!0},e.send(JSON.stringify(i))}(L,e,l),console.log("Socket Opened")}),L.onclose=(()=>{h(s()),l.innerHTML+="<br>Connection to server was lost. Please Reload the page"}),_.onclick=(()=>{const t=a.create("input");a.set(t,"accept","image/*"),a.set(t,"type","file"),t.addEventListener("change",()=>{const s=t.files[0],a=new FileReader;a.onload=(t=>{const n=a.result,i=new Image;i.src=n,i.onload=(async()=>{const t=await async function(e,t,s){const a=document.createElement("canvas");if(void 0===e.naturalWidth&&void 0===e.naturalHeight)return console.log(e,"no natural width"),null;a.width=e.naturalWidth,a.height=e.naturalHeight,a.getContext("2d").drawImage(e,0,0);const n=a.toDataURL(s,t/100),i=await fetch(n);return await i.arrayBuffer()}(i,65,s.type),a=await fetch("/@/binary/",{credentials:"include",method:"post",headers:{"x-file-name":s.name},body:t}),n={media:(await a.json()).url,message:null,user:e,stamp:(new Date).getTime()};L.send(JSON.stringify(n))})}),a.readAsDataURL(s)}),t.click()}),b.onclick=(()=>{if("closed"!=v.getAttribute("data-stat"))return a.set(v,"data-stat","closed"),v.style.marginLeft="-100px";a.set(v,"data-stat","opened"),v.style.marginLeft="0px"}),r.onkeydown=function(e){if(13===e.keyCode&&this.value.replace(/\s/g,"").length>0){const e=(new Date).getTime(),t=r.value,s={user:this.getAttribute("data-user"),message:t,typing:!1,media:null,stamp:e};L.send(JSON.stringify(s)),r.value=""}}}c.oncontextmenu=(e=>{e.preventDefault()}),n.addEventListener("keydown",e=>{13===e.keyCode&&i.click()}),"granted"===Notification.permission&&(console.log("Granted Notification Perm"),e.onMessage(e=>{const t=e.data;console.log("Creating Notification UI"),"function"==typeof s?t.sender!==s()&&u(t):u(t)}));const y=e=>`${Object.keys(e).map(t=>`${encodeURIComponent(t)}=${encodeURIComponent(e[t])}`).join("&")}`;function f(e){e.style.overflow="hidden",e.style.padding="0px",e.style.opacity=0,e.style.height="0",e.style.border="none",e.style.width="0"}function w(e){e.style.padding="5px",e.style.opacity=1,e.style.height="auto",e.style.width="auto",e.style.border="2px solid #e3e3e3",e.style.overflow="visible"}i.onclick=(async()=>{if(l.style.visibility="hidden",0!=n.value.length){r.style.display="block",c.style.display="inline";const e=await fetch(`/api/user-search/tokens/${o}`,{method:"get",credentials:"include"}),t=await e.text(),s=await fetch("/api/users/",{credentials:"include",method:"post",headers:{"content-type":"application/x-www-form-urlencoded"},body:y({token:t,user:n.value})});c.style.display="none",r.style.display="none";try{return function(e){const t=e.users;if(d.innerHTML="",d.style.display="block",0===t.length)return d.innerHTML="No Results Found";for(const e of t){const t=document.createElement("span"),s=document.createElement("button");s.innerHTML=e,t.appendChild(s),a.set(t,"data-result",e),s.className="resbtn",d.appendChild(t),t.onclick=function(){h(this.getAttribute("data-result"))}}}(await s.json())}catch(e){return console.warn(e),l.style.visibility="visible",l.innerHTML="An error occured on our end..please try again"}}})})();