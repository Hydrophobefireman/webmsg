(async()=>{(new Image).src="/static/attachment.svg",(new Image).src="/static/close.svg",(new Image).src="/static/home.svg";const e={id:e=>document.getElementById(e),className:(e,t=!0)=>{const n=Array.from(document.getElementsByClassName(e));return t?n[0]:n},create:e=>document.createElement(e),set:(e,t,n)=>e.setAttribute(t,n)},t=e.id("users"),n=e.id("sbm"),o=document.querySelector("meta[name='nonce']").getAttribute("content"),s=e.id("loading-gif"),a=e.id("messages"),i=e.id("results-all"),c=e.id("username_meta").content;rdetails=e.id("resbox-details"),s.oncontextmenu=(e=>{e.preventDefault()}),t.addEventListener("keydown",e=>{13===e.keyCode&&n.click()});let r,d;if(n.onclick=(async()=>{if(a.style.visibility="hidden",0!=t.value.length){rdetails.style.display="block",s.style.display="inline";const n=await fetch(`/api/user-search/tokens/${o}`,{method:"get",credentials:"include"}),c=await n.text(),r=await fetch("/api/users/",{credentials:"include",method:"post",headers:{"content-type":"application/x-www-form-urlencoded"},body:(e=>`${Object.keys(e).map(t=>`${encodeURIComponent(t)}=${encodeURIComponent(e[t])}`).join("&")}`)({token:c,user:t.value})});s.style.display="none",rdetails.style.display="none";try{return function(t){const n=t.users;if(i.innerHTML="<div>Search Result</div>",i.style.display="block",0===n.length)return i.innerHTML="No Results Found";for(const t of n){const n=e.create("a"),o=e.create("button");o.textContent=t.user,n.appendChild(o),e.set(n,"data-user",t.user),e.set(n,"data-chat_id",t.chat_id),n.href=`/chat/${t.chat_id}`,o.className="resbtn",i.appendChild(n),n.style.textDecoration="none",n.style.color="#000",n.style.display="block"}}(await r.json())}catch(e){return console.warn(e),a.style.visibility="visible",a.innerHTML="An error occured on our end..please try again"}}}),"function"==typeof window.Notification){const t=firebase.messaging();try{console.log("Supports Notifications"),await t.requestPermission(),t.usePublicVapidKey("BGhv7XYjPBkpVoOEPbq2E19Is1ti_MYfboTDazKE0jgxPENxDqe0-U2p1OKEEgG4JH4Ycl8Wbxdv-UrrP_LcLmw"),await t.getToken();const e=async()=>{const e=await t.getToken();console.log("Token refreshed."),console.log(e),await fetch("/@/notify/",{method:"post",headers:{"content-type":"application/x-www-form-urlencoded"},body:`token=${encodeURIComponent(e)}`})};await e(),t.onTokenRefresh(e)}catch(e){console.warn(e),r=!0,console.log("Permission-Denied")}d=(t=>{const n=e.create("div"),o=e.create("div"),s=e.create("div"),a=e.create("div"),i=e.create("span"),r=e.create("span"),d=e.create("input"),p=t.sender,u=t.message,m=t.hasImage,h=t.chat_id;if(e.set(d,"class","notification-reply-bar"),e.set(n,"class","notification-box"),e.set(o,"class","notification-sender"),e.set(s,"class","notification-text"),e.set(a,"class","notification-action-box"),e.set(i,"class","notification-action-button"),e.set(r,"class","notification-action-button"),n.appendChild(o),n.appendChild(s),n.appendChild(a),a.appendChild(i),a.appendChild(r),o.textContent=p,i.textContent=`Reply To ${p}`,r.textContent="Mark As Read",m){const e=new Image;e.src="/static/attachment.svg",s.innerHTML="",s.appendChild(e)}else s.textContent=u;let g;document.body.appendChild(n),i.onclick=(()=>{clearTimeout(g),i.replaceWith(d),d.focus(),d.onkeydown=(e=>{if(13===e.keyCode&&d.value.replace(/\s/g,"").length>0){const e=(new Date).getTime(),t=d.value;l({receiver:p,message:t,media:null,stamp:e,sender:c,chat_id:h}),d.value="",n.remove()}})}),r.onclick=(()=>{l({sender:p,receiver:c,chat_id:h,message:null,read:{id:t.msgid},stamp:(new Date).getTime(),rstamp:(new Date).getTime()}),n.remove()}),s.onclick=o.onclick=(()=>{createChatBox(p)}),setTimeout(()=>{n.style.marginTop="15px",g=setTimeout(()=>{n.remove()},4e3)},500)}),"granted"===Notification.permission?(console.log("Granted Notification Perm"),t.onMessage(e=>{const t=e.data;console.log("Creating Notification UI"),d(t)})):r=!0}else r=!0;function l(e){return new Promise((t,n)=>{let o;"object"==typeof e?o=JSON.stringify(e):"string"==typeof e&&(o=e);const s=`${"https:"===window.location.protocol?"wss://":"ws://"}${window.location.host}/@/messenger/`,a=new WebSocket(s);a.onopen=function(){t(a.send(o))}})}r&&alert("We Cannot send notifications to you.This might cause messaging to slow down"),(async()=>{const t=await fetch("/api/chat_ids/",{method:"post",headers:{"content-type":"application/x-www-form-urlencoded"},body:`user=${encodeURIComponent(document.getElementById("username_meta").content)}`}),n=await t.json(),o=e.id("prev-chats");o.innerHTML="<div>Your Previous Chats</div>";const s=n.previous_chats;if(0===s.length)return o.innerHTML="No previous chats Found";for(const t of s){const n=e.create("div"),s=e.create("button");s.textContent=t.user,n.appendChild(s),e.set(n,"data-user",t.user),e.set(n,"data-chat_id",t.chat_id),s.onclick=(e=>window.location=`/chat/${t.chat_id}`),s.className="resbtn",o.appendChild(n)}})()})();