(async()=>{(new Image).src="/static/attachment.svg",(new Image).src="/static/close.svg";const e={id:e=>document.getElementById(e),className:(e,t=!0)=>{const s=Array.from(document.getElementsByClassName(e));return t?s[0]:s},create:e=>document.createElement(e),set:(e,t,s)=>e.setAttribute(t,s)},t=e.id("users"),s=e.id("sbm"),a=document.querySelector("meta[name='nonce']").getAttribute("content"),n=e.id("loading-gif"),i=e.id("messages"),l=e.id("results-all"),o=e.id("resbox-details"),d=e.id("res"),c=e.id("username_meta").getAttribute("content"),r=e.id("searchbox");function p(t){l.innerHTML="",d.style.display="none",r.style.display="none";const s=e.create("div"),a=e.create("div"),n=e.create("div"),i=e.create("div"),o=e.create("input"),m=e.create("img"),u=e.create("span"),g=e.create("div"),y=e.create("span"),h=e.create("img"),f=e.create("div"),v=e.create("div"),C=e.create("img");e.set(g,"data-stat","closed"),e.set(g,"class","menu-details"),e.set(y,"class","menubox"),e.set(o,"type","text"),e.set(o,"placeholder","Type a Message"),e.set(s,"class","chat_box_wrap"),e.set(a,"class","chat_box"),e.set(n,"class","chat_head"),e.set(i,"class","chat_body"),e.set(o,"class","chat_inp"),e.set(m,"class","context"),e.set(f,"class","img-button-holder"),e.set(v,"class","img-button-holder"),e.set(C,"title","Attach a File"),e.set(h,"title","Close this Chat"),e.set(o,"data-user",t),f.appendChild(h),v.appendChild(C),g.appendChild(f),g.appendChild(v),n.appendChild(y),n.appendChild(u),a.appendChild(n),a.appendChild(g),a.appendChild(i),a.appendChild(o),a.appendChild(m),s.appendChild(a),l.appendChild(s),h.onclick=(()=>{e.id("message-info").innerHTML="",e.id("message-info").style.opacity="0.0",l.innerHTML="",l.style.display="none",r.style.display="block",d.style.display="block"}),y.innerHTML="&#9776;",u.textContent=t,h.src="/static/close.svg",C.src="/static/attachment.svg",h.style.cursor="pointer",C.style.cursor="pointer";const w=`${("https:"===window.location.protocol?"wss://":"ws://")+window.location.host}/@/messenger/`,b=new WebSocket(w);b.onmessage=(t=>{const s=t.data;try{const a=JSON.parse(s);if(a.hasOwnProperty("error"))return console.log("prop-error",a),i.innerHTML+="<br>An error occured Please reload the page";!function t(s,a){function n(t,s,a,n,i,l,o,d,r=null){let p;const m=e.create("div");if(a===c?(p="msg_sent",m.style.marginLeft="auto"):(p="msg_recieved",m.style.marginRight="auto"),e.set(m,"class",`msg ${p}`),r){e.set(m,"data-media",r);const t=new Image;t.src="/static/attachment.svg",m.appendChild(t),m.style.fontSize="12px",m.appendChild+="Media Message"}else e.set(m,"data-media",null),m.textContent=s;function u(e){e.style.padding="5px",e.style.opacity=1,e.style.height="auto",e.style.width="auto",e.style.border="2px solid #e3e3e3",e.style.overflow="visible"}e.set(m,"data-sender",a),e.set(m,"data-receiver",n),e.set(m,"data-stamp",i),e.set(m,"data-msgid",l),e.set(m,"data-read",o),e.set(m,"data-rstamp",d),t.appendChild(m),t.scrollTop=t.scrollHeight,m.onclick=function(){const t=this.dataset,s=t.sender,a=(t.receiver,parseInt(t.stamp)),n=(t.msgid,t.read),i=parseInt(t.rstamp),l=t.media,o=e.id("message-info");o.innerHTML="",o.style.opacity="1";const d=e.create("div");e.set(d,"class","message-close"),d.innerHTML="Close";const r=e.create("div");r.style.transition="0.3s ease-in-out",o.appendChild(d),o.appendChild(r),d.onclick=(()=>{r.style.opacity="0",r.style.height="0px",o.style.opacity="0",o.innerHTML=""});const p=e.create("div"),m=e.create("div"),g=e.create("div"),y=e.create("div"),h=e.create("div"),f=e.create("div");function v(e,t){var s;"out"===e.getAttribute("data-slide")?(u(t),e.setAttribute("data-slide","in")):(e.setAttribute("data-slide","out"),(s=t).style.overflow="hidden",s.style.padding="0px",s.style.opacity=0,s.style.height="0",s.style.border="none",s.style.width="0")}if(e.set(p,"class","message-info-key"),e.set(p,"data-slide","out"),e.set(m,"class","message-info-value"),e.set(g,"class","message-info-key"),e.set(g,"data-slide","out"),e.set(y,"class","message-info-value"),e.set(h,"class","message-info-key"),e.set(h,"data-slide","out"),e.set(f,"class","message-info-value"),p.onclick=(()=>{v(p,m)}),g.onclick=(()=>{v(g,y)}),h.onclick=(()=>{v(h,f)}),p.textContent="Sender",m.textContent=s+(s===c?"(You)":""),h.textContent="Time",f.textContent=new Date(a).toLocaleString(),g.textContent="Read-Status",y.textContent="true"===n?`Read (${isNaN(i)?"N/A":new Date(i).toLocaleString()})`:"Sent","null"!==l){const t=e.create("div"),s=e.create("div");e.set(t,"class","message-info-key"),e.set(s,"class","message-info-value"),t.textContent="Media Message",s.innerHTML="Click To Open Media Preview",s.style.cursor="pointer",e.set(s,"data-media",l),u(s),s.onclick=(()=>{const t=s.dataset,a=new Image;a.src=t.media,r.innerHTML="";const n=e.create("a");r.appendChild(a),r.appendChild(n),n.style.color="black",n.style.textDecoration="none",n.target="__blank",n.style.display="block",n.innerHTML="Click To Open Image In A New Tab",n.href=t.media,a.style.width="160px",a.style.height="100px"}),r.appendChild(t),r.appendChild(s)}o.style.display="block",r.appendChild(p),r.appendChild(m),r.appendChild(h),r.appendChild(f),r.appendChild(g),r.appendChild(y),console.log(t)}}if(a.typing)return u.style.color="green";u.style.color="#fff";if(a.fetch){console.log("FETCHED DETAILS");const e=a.data;for(let a=0;a<Object.keys(e).length;a++){const n=e[a];n.msgid=a,t(s,n)}}let i,l,o,d,r,p,m;if((a.media||a.message)&&!a.read&&!a.rstamp&&a.sender!==c){const e={user:a.sender,message:null,read:{id:a.msgid},stamp:(new Date).getTime(),rstamp:(new Date).getTime()};b.send(JSON.stringify(e))}if(a.message)return i=a.message,l=a.sender,o=a.receiver,d=a.stamp,r=a.read,p=a.rstamp,m=a.msgid,n(s,i,l,o,d,m,r,p);if(a.update){const t=a.msgid,s=document.querySelector(`div[data-msgid='${t}']`);e.set(s,"data-read",a.update.read),e.set(s,"data-rstamp",a.update.rstamp)}if(a.media){const e=a.mediaURL;l=a.sender,o=a.receiver,r=a.read,p=a.rstamp,d=a.stamp,m=a.msgid,n(s,null,l,o,d,m,r,p,e)}}(i,a)}catch(t){console.log(t,"ERR"),i.innerHTML+="<br>An error occured Please reload the page"}}),b.onopen=(()=>{!function(e,t){const s={stamp:(new Date).getTime(),message:null,user:t,fetch_messages:!0};e.send(JSON.stringify(s))}(b,t),console.log("Socket Opened")}),b.onclose=(()=>{p(t),i.innerHTML+="<br>Connection to server was lost. Please Reload the page"}),C.onclick=(()=>{const s=e.create("input");e.set(s,"accept","image/*"),e.set(s,"type","file"),s.addEventListener("change",()=>{const e=s.files[0],a=new FileReader;a.onload=(s=>{const n=a.result,i=new Image;i.src=n,i.onload=(async()=>{const s=await async function(e,t,s){const a=document.createElement("canvas");if(void 0===e.naturalWidth&&void 0===e.naturalHeight)return console.log(e,"no natural width"),null;a.width=e.naturalWidth,a.height=e.naturalHeight,a.getContext("2d").drawImage(e,0,0);const n=a.toDataURL(s,t/100),i=await fetch(n);return await i.arrayBuffer()}(i,65,e.type),a=await fetch("/@/binary/",{credentials:"include",method:"post",headers:{"x-file-name":e.name},body:s}),n={media:(await a.json()).url,message:null,user:t,stamp:(new Date).getTime()};b.send(JSON.stringify(n))})}),a.readAsDataURL(e)}),s.click()}),y.onclick=(()=>{if("closed"!=g.getAttribute("data-stat"))return e.set(g,"data-stat","closed"),g.style.marginLeft="-100px";e.set(g,"data-stat","opened"),g.style.marginLeft="0px"}),o.onkeydown=function(e){if(13===e.keyCode&&o.value.replace(/\s/g,"").length>0){const e=(new Date).getTime(),t=o.value,s={user:this.getAttribute("data-user"),message:t,typing:!1,media:null,stamp:e};b.send(JSON.stringify(s)),o.value=""}}}n.oncontextmenu=(e=>{e.preventDefault()}),t.addEventListener("keydown",e=>{13===e.keyCode&&s.click()});s.onclick=(async()=>{if(i.style.visibility="hidden",0!=t.value.length){o.style.display="block",n.style.display="inline";const s=await fetch(`/api/user-search/tokens/${a}`,{method:"get",credentials:"include"}),d=await s.text(),c=await fetch("/api/users/",{credentials:"include",method:"post",headers:{"content-type":"application/x-www-form-urlencoded"},body:(e=>`${Object.keys(e).map(t=>`${encodeURIComponent(t)}=${encodeURIComponent(e[t])}`).join("&")}`)({token:d,user:t.value})});n.style.display="none",o.style.display="none";try{return function(t){const s=t.users;if(l.innerHTML="",l.style.display="block",0===s.length)return l.innerHTML="No Results Found";for(const t of s){const s=document.createElement("span"),a=document.createElement("button");a.innerHTML=t,s.appendChild(a),e.set(s,"data-result",t),a.className="resbtn",l.appendChild(s),s.onclick=function(){p(this.getAttribute("data-result"))}}}(await c.json())}catch(e){return console.warn(e),i.style.visibility="visible",i.innerHTML="An error occured on our end..please try again"}}})})();