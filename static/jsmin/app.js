(async()=>{let e;(new Image).src="/static/attachment.svg",(new Image).src="/static/close.svg",(new Image).src="/static/home.svg";const t=e=>`${Object.keys(e).map(t=>`${encodeURIComponent(t)}=${encodeURIComponent(e[t])}`).join("&")}`;function n(e){e.style.overflow="hidden",e.style.padding="0px",e.style.opacity=0,e.style.height="0",e.style.border="none",e.style.width="0"}function a(e){e.style.padding="5px",e.style.opacity=1,e.style.height="auto",e.style.width="auto",e.style.border="2px solid #e3e3e3",e.style.overflow="visible"}const s={login:{fields_empty_or_session_error:"Check Your Username and Password or try to reload the page",no_such_user:"No Such User Exists",incorrect_password:"incorrect password"},register:{fields_empty_or_session_error:"Check Your Username and Password or try to reload the page",bad_request:"Bad Username or Password",username_taken:"Username Already Taken"}},i=document.getElementById("app-root"),o={q:(e,t=!0)=>{const n=Array.from(document.querySelectorAll(e));return t?n[0]:n},id:e=>document.getElementById(e),className:(e,t=!0)=>{const n=Array.from(document.getElementsByClassName(e));return t?n[0]:n},create:(e,t,n=!0)=>{const a=document.createElement(e);if("object"==typeof t){const e=Object.keys(t);for(const n of e)a.setAttribute(n,t[n])}return n&&a.setAttribute("data-trace",[...Array(15)].map(e=>(~~(36*Math.random())).toString(36)).join("")),a},set:(e,t,n)=>e.setAttribute(t,n),empty:e=>{let t;for(t=e.lastChild;t;)e.removeChild(t),t=e.lastChild}};async function r(e){const n=e[0];o.empty(i);const a=await p.getUser();if(!a)return l("Not Logged In..redirecting to '/'"),p.route("/");if(n!==a)return p.route(`/u/${a}`);document.title=`${a} - Profile`;const s=await p.getIntegrity(),r=o.create("div",{id:"searchbox"}),c=o.create("div",{id:"messages",class:"__messages__"}),d=o.create("input",{class:"input_n",id:"users",type:"text",placeholder:"Search for a User",spellcheck:!1}),u=o.create("button",{id:"sbm",class:"submit-button"});u.textContent="Search";const h=o.create("div",{id:"errmsgs"});r.appendChild(c),r.appendChild(d),r.appendChild(u),r.appendChild(h);const g=o.create("div",{id:"res"}),y=o.create("div",{class:"resbox-details",style:"margin-top: 20px"}),m=new Image;m.oncontextmenu=(e=>{e.preventDefault()}),m.src="/static/loading.gif",y.appendChild(m),m.id="loading-gif",g.appendChild(y);const f=o.create("div",{id:"results-all"}),w=o.create("div",{id:"prev-chats"});i.appendChild(r),i.appendChild(g),i.appendChild(f),i.appendChild(w),d.addEventListener("keydown",e=>{13===e.keyCode&&u.click()}),u.onclick=(async()=>{if(c.style.visibility="hidden",0!=d.value.length){y.style.display="block",m.style.display="inline";const e=await fetch(`/api/user-search/tokens/${s}`,{method:"get",credentials:"include"}),n=await e.text(),a=await fetch("/api/users/",{credentials:"include",method:"post",headers:{"content-type":"application/x-www-form-urlencoded"},body:t({token:n,user:d.value})});m.style.display="none",y.style.display="none";try{return function(e){const t=e.users;if(f.innerHTML="<div>Search Result</div>",f.style.display="block",0===t.length)return f.innerHTML="No Results Found";for(const e of t){const t=o.create("a"),n=o.create("button");n.textContent=e.user,t.appendChild(n),o.set(t,"data-user",e.user),o.set(t,"data-chat_id",e.chat_id),t.href=`/#/chat/${e.chat_id}`,n.className="resbtn",f.appendChild(t),t.style.textDecoration="none",t.style.color="#000",t.style.display="block"}}(await a.json())}catch(e){return console.warn(e),c.style.visibility="visible",c.innerHTML="An error occured on our end..please try again"}}}),(async()=>{const e=await fetch("/api/chat_ids/",{method:"post",headers:{"content-type":"application/x-www-form-urlencoded"},body:`user=${encodeURIComponent(await p.getUser())}`}),t=await e.json();w.innerHTML="<div>Your Previous Chats</div>";const n=t.previous_chats;if(0===n.length)return w.innerHTML="No previous chats Found";for(const e of n){const t=o.create("div"),n=o.create("button");n.textContent=e.user,t.appendChild(n),o.set(t,"data-user",e.user),o.set(t,"data-chat_id",e.chat_id),n.onclick=(()=>window.location.href=`/#/chat/${e.chat_id}`),n.className="resbtn",w.appendChild(t)}})()}async function c(e){let t;o.empty(i),t=!0;const s=e[0],r=[];if(!await p.validateChat(s))return p._errstatus(500);const c=o.create("div",{id:"results-all"});i.appendChild(c),i.appendChild(o.create("div",{id:"message-info"}));const d=p.chat_with,u=p.chat_id,h=await p.getUser();let g;async function y(e,t){async function s(e,t,s,i,r,c,d,p,u=null){let g;if(o.q(`div[data-msgid='${c}']`))return l(`Element with ID:${c} already exists..skipping`);const y=o.create("div");if(s===h?(g="msg_sent",y.style.marginLeft="auto"):(g="msg_recieved",y.style.marginRight="auto"),o.set(y,"class",`msg ${g}`),u){o.set(y,"data-media",u);const e=new Image;e.src="/static/attachment.svg",y.appendChild(e),y.style.fontSize="12px",y.appendChild+="Media Message"}else o.set(y,"data-media",null),y.textContent=t;let m;o.set(y,"data-sender",s),o.set(y,"data-receiver",i),o.set(y,"data-stamp",r),o.set(y,"data-msgid",c),o.set(y,"data-read",d),o.set(y,"data-rstamp",p),e.appendChild(y),e.scrollTop=e.scrollHeight,y.onclick=function(){!function(e){const t=e.dataset,s=t.sender,i=parseInt(t.stamp),r=t.read,c=parseInt(t.rstamp),d=t.media,l=o.id("message-info");l.innerHTML="",l.style.opacity="1";const p=o.create("div");o.set(p,"class","message-close"),p.textContent="Close";const u=o.create("div");u.style.transition="0.3s ease-in-out",l.appendChild(p),l.appendChild(u),p.onclick=(()=>{u.style.opacity="0",u.style.height="0px",l.style.opacity="0",l.innerHTML=""});const g=o.create("div"),y=o.create("div"),m=o.create("div"),f=o.create("div"),w=o.create("div"),v=o.create("div");o.set(g,"class","message-info-key"),o.set(g,"data-slide","out"),o.set(y,"class","message-info-value"),o.set(m,"class","message-info-key"),o.set(m,"data-slide","out"),o.set(f,"class","message-info-value"),o.set(w,"class","message-info-key"),o.set(w,"data-slide","out"),o.set(v,"class","message-info-value"),g.onclick=(()=>{a(y),n(g)}),y.onclick=(()=>{a(g),n(y)}),m.onclick=(()=>{a(f),n(m)}),f.onclick=(()=>{a(m),n(f)}),w.onclick=(()=>{a(v),n(w)}),v.onclick=(()=>{a(w),n(v)}),g.textContent="Sender",y.textContent=s+(s===h?"(You)":""),w.textContent="Time",v.textContent=new Date(i).toLocaleString(),m.textContent="Read-Status",f.textContent="true"===r?`Read (${isNaN(c)?"N/A":new Date(c).toLocaleString()})`:"Sent",s!==h&&(m.style.display="none",f.style.display="none");if("null"!==d){const e=o.create("div"),t=o.create("div");o.set(e,"class","message-info-key"),o.set(t,"class","message-info-value"),e.textContent="Media Message",t.textContent="Click To Open Media Preview",t.style.cursor="pointer",o.set(t,"data-media",d),a(t),t.onclick=(()=>{const e=t.dataset,n=new Image;n.src=e.media,u.innerHTML="";const a=o.create("a");u.appendChild(n),u.appendChild(a),a.style.color="black",a.style.textDecoration="none",a.target="__blank",a.style.display="block",a.textContent="Click To Open Image In A New Tab",a.href=e.media,n.style.width="160px",n.style.height="100px"}),u.appendChild(e),u.appendChild(t)}l.style.display="block",u.appendChild(g),u.appendChild(y),u.appendChild(w),u.appendChild(v),u.appendChild(m),u.appendChild(f),console.log(t)}(this)},(m=await $get(o.__chatID__))&&(m[c]||(console.log("[indexedDB]Adding new entry:",c),m[c]={message:t,sender:s,stamp:r,read:d,media:!!u||null,mediaURL:u,rstamp:p,receiver:i},await $set(o.__chatID__,m)))}const i=o.id("__chat-with-prof");if(t.typing)return i.style.color="green";if(i.style.color="#000",t.fetch){console.log("FETCHED DETAILS");const n=t.data;if(t.full_fetch)console.log("[indexedDB]Setting Full Cache to indexedDB:",n),await $set(o.__chatID__,n);else{const e=await $get(o.__chatID__),t=Object.assign({},e,n);await $set(o.__chatID__,t)}const a=t.fetched_from;for(let t=0;t<Object.keys(n).length;t++){let s;const i=n[s=isNaN(a)?t:t+a];i&&(i.msgid=s,await y(e,i))}return}let r,c,p,g,m,f,w;if(t.media||t.message){if(t.sender!==h&&t.receiver!==h||t.sender!==d&&t.receiver!==d)throw console.log(t),new Error("Invalid Sender and recepient arguments");if(!t.read&&!t.rstamp&&t.sender!==h){const e={receiver:t.sender,sender:h,chat_id:u,message:null,read:{id:t.msgid},stamp:(new Date).getTime(),rstamp:(new Date).getTime()};await b(e)}}if(t.message)return r=t.message,c=t.sender,p=t.receiver,g=t.stamp,m=t.read,f=t.rstamp,s(e,r,c,p,g,w=t.msgid,m,f);if(t.update){const e=t.msgid,n=document.querySelector(`div[data-msgid='${e}']`);if(n){o.set(n,"data-read",t.update.read),o.set(n,"data-rstamp",t.update.rstamp),console.log("updating data");const a=await $get(u),s=Object.assign({},a);s[e].read=t.update.read,s[e].rstamp=t.update.rstamp,await $set(u,s)}}if(t.media){const n=t.mediaURL;c=t.sender,p=t.receiver,m=t.read,f=t.rstamp,s(e,null,c,p,g=t.stamp,w=t.msgid,m,f,n)}}async function m(e){o.__chatID__=u,c.innerHTML="",c.style.display="block";const t=o.create("div"),n=o.create("div"),a=o.create("div"),s=o.create("div"),i=o.create("input"),r=o.create("img"),l=o.create("span"),g=o.create("div"),y=o.create("span"),m=o.create("div"),f=o.create("div"),w=o.create("div");l.id="__chat-with-prof",o.set(g,"data-stat","closed"),o.set(l,"class","chat_with"),o.set(g,"class","menu-details"),g.id="__menubox__",o.set(y,"class","menubox"),o.set(i,"type","text"),o.set(i,"placeholder","Type a Message"),o.set(t,"class","chat_box_wrap"),o.set(n,"class","chat_box"),o.set(a,"class","chat_head"),o.set(s,"class","chat_body"),o.set(i,"class","chat_inp"),o.set(r,"class","context"),o.set(m,"class","img-button-holder"),o.set(w,"class","img-button-holder"),o.set(f,"class","img-button-holder"),o.set(i,"data-user",e),s.id="_msg_body",g.appendChild(m),g.appendChild(w),g.appendChild(f),a.appendChild(y),a.appendChild(l),n.appendChild(a),n.appendChild(g),n.appendChild(s),n.appendChild(i),n.appendChild(r),t.appendChild(n),y.innerHTML="&#9776;",l.textContent=e,f.textContent="Start WebRTC Session",c.appendChild(t),m.onclick=(()=>{p.route(`/u/${h}`)}),y.id="Nzk3NzEzOD",m.textContent="Close Conversation",w.textContent="Add An Attachment",y.onclick=(()=>{if("closed"!=g.getAttribute("data-stat"))return o.set(g,"data-stat","closed"),g.style.marginBottom="-250px";o.set(g,"data-stat","opened"),g.style.marginBottom="0px"}),f.onclick=(async()=>{}),w.onclick=(()=>{const t=o.create("input");o.set(t,"accept","image/*"),o.set(t,"type","file"),y.click(),t.addEventListener("change",()=>{const n=t.files[0],a=new FileReader;a.onload=(t=>{const s=a.result,i=new Image;i.src=s,i.onload=(async()=>{const t=await async function(e,t,n){const a=document.createElement("canvas");if(void 0===e.naturalWidth&&void 0===e.naturalHeight)return console.log(e,"no natural width"),null;a.width=e.naturalWidth,a.height=e.naturalHeight,a.getContext("2d").drawImage(e,0,0);const s=a.toDataURL(n,t/100),i=await fetch(s);return await i.arrayBuffer()}(i,65,n.type),a=await fetch("/@/binary/",{credentials:"include",method:"post",headers:{"x-file-name":n.name},body:t}),s={media:(await a.json()).url,message:null,receiver:e,sender:h,chat_id:u,stamp:(new Date).getTime()};await b(s)})}),a.readAsDataURL(n)}),t.click()}),i.onkeydown=async function(e){if(13===e.keyCode&&this.value.replace(/\s/g,"").length>0){const e=(new Date).getTime(),t=i.value,n={sender:h,receiver:d,chat_id:u,message:t,typing:!1,media:null,stamp:e};i.value="";await b(n)}}}function f(e,t){return console.log("Settimeout func"),"chat"===p.currentFuncRoute()?(console.log(`${p.currentFuncRoute()}->Current Route`),setTimeout(e,t)):l("Ignoring Timeout ")}async function w(){let e;console.log(`[-] Manually Checking For Messages [Periodic Timer:${g}]`),await async function(e=o.id("_msg_body")){if("chat"!==p.currentFuncRoute())return l("Removed Chat Context->");const n=await $get(u);let a;console.log("new template");const s=document.createElement("div");if(s.className="chat_body",n){const i=Object.keys(n).length;console.log("Checking For Updated Data"),a={stamp:(new Date).getTime(),message:null,sender:h,chat_id:u,receiver:d,fetch_messages:!0,fetch_from:i-1};for(let e=0;e<i;e++){const t=n[e];t&&(t.msgid=e,await y(s,t))}const o=e.scrollTop;e.replaceWith(s),s.scrollTop=t?s.scrollHeight:o,s.id="_msg_body",s.onclick=(()=>{C()}),e.remove(),_resp=await b(a)}else console.log("Fetching New"),a={stamp:(new Date).getTime(),message:null,sender:h,chat_id:u,receiver:d,fetch_messages:!0},_resp=await b(a)}(),e=f(await w,2e4)}g=1e4;const v=`${"https:"===window.location.protocol?"wss://":"ws://"}${window.location.host}/@/messenger/`,_=new WebSocket(v);function C(){const e=o.id("Nzk3NzEzOD");"opened"===o.id("__menubox__").getAttribute("data-stat")&&e.click()}async function b(e,t="/@/messenger/"){let n;"object"==typeof e?n=JSON.stringify(e):"string"==typeof e&&(n=e),_.send(n)}console.log(_),_.onmessage=(e=>{const t=e.data;"pong"!==t&&function(e){const t=o.id("_msg_body");try{const n=JSON.parse(e);if(n.hasOwnProperty("error"))return console.log("prop-error",n),t.innerHTML+="<br>An error occured Please reload the page";y(t,n)}catch(e){console.log(e,"ERROR in parsing message"),t.innerHTML+="<br>An error occured Please reload the page"}}(t)}),_.onopen=(async()=>{console.log("Opened Socket"),m(d),await w(),t=!1,o.id("_msg_body").onclick=(()=>{C()}),function e(){_.readyState!==_.CLOSED&&_.readyState!==_.CLOSING&&_.send("ping"),console.log("keeping alive"),f(e,3e4),r.push(void 0)}()}),_.onclose=(()=>{o.id("_msg_body").innerHTML="<br>Connection to server was lost. Please Reload the page"})}async function d(){o.empty(i);const e=await p.getUser();e&&(l(`Logged In->routing to:${e}`),p.route(`/u/${e}`));const n=o.create("div",{class:"main"}),a=o.create("button",{id:"login"});a.textContent="Login";const r=o.create("button",{id:"signup"});r.textContent="Signup";const c=o.create("div",{class:"errors-and-notices"});c.style.color="red";const d=o.create("div",{id:"lfbox"});d.style.display="none";const u=o.create("div",{"data-action":"/login/check",id:"login-form"}),h=o.create("input",{type:"text",class:"input_x",name:"user",id:"username-log",placeholder:"Username"}),g=o.create("input",{type:"password",id:"password-log",class:"input_x",placeholder:"Password",name:"password"}),y=o.create("button",{class:"submit-button",id:"login-btn"});y.textContent="Login",u.appendChild(h),u.appendChild(g),d.appendChild(u),d.appendChild(y);const m=o.create("div",{id:"rfbox"});m.style.display="none";const f=o.create("div",{id:"register-form","data-action":"/register/check/"}),w=o.create("div",{id:"__errs__"}),v=o.create("input",{type:"text",class:"input_x",name:"user",id:"username-reg",placeholder:"Username"}),_=o.create("input",{type:"password",class:"input_x",id:"password-reg",placeholder:"Password",name:"password"}),C=o.create("input",{type:"password",id:"password-reg-conf",class:"input_x",placeholder:"Confirm Password",name:"password"}),b=o.create("button",{class:"submit-button",id:"register-btn"});b.textContent="Signup",f.appendChild(w),f.appendChild(v),f.appendChild(_),f.appendChild(C),m.appendChild(f),m.appendChild(b),n.appendChild(a),n.appendChild(r),n.appendChild(c),n.appendChild(d),n.appendChild(m),i.appendChild(n),a.onclick=(()=>{login.style.backgroundColor="#6200ee",login.style.color="#fff",r.style.backgroundColor="#fff",r.style.color="#6200ee",o.id("lfbox").style.display="block",o.id("rfbox").style.display="none"}),r.onclick=(()=>{r.style.backgroundColor="#6200ee",r.style.color="#fff",a.style.backgroundColor="#fff",a.style.color="#6200ee",o.id("rfbox").style.display="block",o.id("lfbox").style.display="none"}),String.prototype.isValid=function(){if(this.length>0)return/^[0-9a-zA-Z_.-]+$/.test(this)};const k=await p.getIntegrity();console.log(k),b.addEventListener("click",async()=>{const e=_.value,n=C.value;if(e!==n)return c.textContent="Passwords Do not Match!";{c.textContent="Loading";const a=await fetch("/register/check/",{credentials:"include",headers:{"content-type":"application/x-www-form-urlencoded"},method:"post",body:t({user:v.value,password:e,checkpw:n,integrity:k})});try{const e=await a.json();if(403===a.status){const t=s.register[e.error];c.innerHTML=t}else 200!==a.status?c.innerHTML="An Error Occured..please reload the page and try again":c.innerHTML="Account Created. Please Login"}catch(e){return console.log(e),c.innerHTML="An Error Occured..please reload the page and try again"}}}),y.addEventListener("click",async()=>{c.innerHTML="Loading";const e=await fetch("/login/check/",{credentials:"include",method:"post",headers:{"content-type":"application/x-www-form-urlencoded"},body:t({user:h.value,password:g.value,integrity:k})});try{const t=await e.json();if(403===e.status){const e=s.login[t.error];c.innerHTML=e}else 200!==e.status?c.innerHTML="An Error Occured..please reload the page and try again":(c.textContent="Authenticated",p.route(`/u/${t.user}`))}catch(e){return console.log(e),c.innerHTML="An Error Occured..please reload the page and try again"}}),g.addEventListener("keydown",e=>{const t=h;0!==g.value.length&&0!==t.value.length&&13===e.keyCode&&y.click()});const x=v,T=_,L=C;check_passwords=(e=>{e.value!==T.value?(w.style.visibility="visible",w.innerHTML="Passwords Do Not Match!",registerbtn.disabled=!0):(w.style.visibility="hidden",o.empty(w),b.disabled=!1)}),L.oninput=(({target:e})=>{check_passwords(e)}),L.onkeydown=(e=>{13!==e.keyCode||registerbtn.disabled||registerbtn.click()}),T.oninput=(()=>{L.value.length>0&&check_passwords(L)}),x.oninput=(({target:e})=>{errs.style.visibility="hidden",o.empty(errs),function(e){const t=e.value;t.isValid()?t.length<4?(w.style.visibility="visible",w.innerHTML="Username Too Short",T.disabled=!0,L.disabled=!0):t.length>30?(w.style.visibility="visible",w.innerHTML="Username Too Long",T.disabled=!0,L.disabled=!0):(T.disabled=!1,L.disabled=!1):(w.style.visibility="visible",w.innerHTML="Invalid Characters!",T.disabled=!0,L.disabled=!0)}(e)})}function l(e,t="warn"){(0,console[t])(`[${performance.now()}]=>${e}`)}const p=new class{constructor(){this.RouteParser=(e=>{try{return new URL(e).hash.substr(1)||"/"}catch(e){return l(e),"/"}}),this.HERE=null,this.integrity=o.q("meta[name='integrity']").getAttribute("content"),this.prevKey=null,this.chat_id=null,this.chat_with=null,this.host=window.location.hostname,this.first_location=window.location.href,this.first_route=this.RouteParser(this.first_location)}async getCurrChat(){return 0!==this.currentRoute().indexOf("/chat/")?null:this.chat_with}async validateChat(e){const n=await fetch("/api/validate-chat/",{method:"post",body:t({chat_id:e}),headers:{"content-type":"application/x-www-form-urlencoded"},credentials:"include"}),a=await n.json();return!a.hasOwnProperty("error")&&(this.chat_id=a.chat_id,this.chat_with=a.chat_with,!0)}async getUser(){const e=await fetch("/api/getuser",{credentials:"include"});if(!e.ok)return null;const t=await e.text();return this.HERE=t,this.HERE}_errstatus(e){switch(e){case 404:i.innerHTML='\n                    <div>404:The requested URL was not found</div>\n                    <div><a href="/#/">Click To Go  Back</a></div>';case 500:i.innerHTML='\n                    <div>500:An error occured while processing your request</div>\n                    <div><a href="/#/">Click To Go  Back</a></div>'}}currentRoute(){return location.hash.substr(1)}currentFuncRoute(){return this.currentRoute().split("/")[1]}route(e){if(this.RouteParser(location.href)!==e)return window.location.hash=e;let t;""===(t=e.split("/")[1])&&(t="/");const n=e.split("/");if(!["/","chat","u","login"].includes(t))return p._errstatus(404),l(`[app route->${e}]No Such Route`);this.paintPage(t,n.filter(e=>n.indexOf(e)>1))}paintPage(e,t){if({"/":0,chat:1,u:1}[e]!==t.length)return p._errstatus(404);const n={"/":d,chat:c,u:r}[e];l(`Painting Page for Route:${e}`),n(t)}async getIntegrity(){const e=await fetch("/api/integrity/",{method:"post",body:t({key:this.prevKey||this.integrity}),credentials:"include",headers:{"content-type":"application/x-www-form-urlencoded"}});let n;try{n=await e.json()}catch(e){console.warn(e)}const a=n.key;return this.prevKey=a,this.integrity=null,a}notifyUser(e,t){let n,a,s,i,r,c,d,l,p,u,h,g,y;p=o.create("div",{class:"notification-box"}),h=o.create("div",{class:"notification-sender"}),g=o.create("div",{class:"notification-text"}),(d=t.hasAction)&&(i=o.create("div",{class:"notification-action-box"}),(r=o.create("div",{class:"notification-action-button"})).textContent=t.actionText||"Example Button",i.appendChild(r)),n=t.body||"New Notification",g.textContent=n,a=t.messageMode,l=t.messageOnClick,g.onclick=h.onclick="__close__"===l?()=>{o.empty(p),p.remove()}:l,h.textContent=e,a?((s=!!t.mediaURL)&&((y=new Image).src="/static/attachment.svg",o.empty(g),g.appendChild(y)),c=t.chat_id,d&&(r.onclick=(()=>{this._respondToNotification(u,r,c,e,p)}))):d&&(r.onclick=void 0),p.appendChild(h),p.appendChild(g),d&&p.appendChild(i),document.body.appendChild(p),setTimeout(()=>{p.style.marginTop="15px",u=setTimeout(()=>{p.remove()},4e3)},500)}_respondToNotification(e,t,n,a,s){let i;var r;clearTimeout(e),i=o.create("input",{class:"notification-reply-bar"}),t.replaceWith(i),i.focus(),i.onkeydown=(async e=>{if(13===e.keyCode&&i.value.replace(/\s/g,"").length>0){const e=(new Date).getTime(),t=i.value,o={receiver:a,message:t,media:null,stamp:e,sender:await this.getUser(),chat_id:n};r=o,new Promise((e,t)=>{let n;"object"==typeof r?n=JSON.stringify(r):"string"==typeof r&&(n=r);const a="https:"===window.location.protocol?"wss://":"ws://",s=`${a}${window.location.host}/@/messenger/`,i=new WebSocket(s);i.onopen=(()=>{e(i.send(n))})}),i.value="",s.remove()}})}};if(o.set(i,"curr-route",p.first_route),window.onhashchange=(()=>{const e=window.location.hash.substr(1);l(`app route->${e}`,"log"),p.route(e),o.set(i,"curr-route",e)}),p.route(p.first_route),"function"==typeof window.Notification){const t=firebase.messaging();try{console.log("Supports Notifications"),await t.requestPermission(),t.usePublicVapidKey("BGhv7XYjPBkpVoOEPbq2E19Is1ti_MYfboTDazKE0jgxPENxDqe0-U2p1OKEEgG4JH4Ycl8Wbxdv-UrrP_LcLmw"),await t.getToken();const n=async()=>{const e=await t.getToken();console.log("Token refreshed."),console.log(e),await fetch("/@/notify/",{method:"post",headers:{"content-type":"application/x-www-form-urlencoded"},body:`token=${encodeURIComponent(e)}`})};await n(),t.onTokenRefresh(n)}catch(t){console.warn(t),e=!0,console.log("Permission-Denied")}"granted"===Notification.permission?(console.log("Granted Notification Perm"),t.onMessage(async e=>{const t=await p.getCurrChat(),n=e.data,a=n.chat_id,s=n.sender;if(t===s)return l("Not creating notification for current chat");const i=n.message,o=n.hasImage,r=`Reply to ${s}`;console.log("Creating Notification UI"),console.log("DATA:",n),p.notifyUser(s,{body:i,chat_id:a,mediaURL:o,hasAction:!0,actionText:r,messageMode:!0})})):e=!0}else e=!0;e&&p.notifyUser("Notification Error",{body:"We Cannot send notifications to you.This might cause messaging to slow down",messageOnClick:"__close__"})})();