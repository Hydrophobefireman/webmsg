!function(e){var t={};function n(o){if(t[o])return t[o].exports;var s=t[o]={i:o,l:!1,exports:{}};return e[o].call(s.exports,s,s.exports,n),s.l=!0,s.exports}n.m=e,n.c=t,n.d=function(e,t,o){n.o(e,t)||Object.defineProperty(e,t,{enumerable:!0,get:o})},n.r=function(e){"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(e,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(e,"__esModule",{value:!0})},n.t=function(e,t){if(1&t&&(e=n(e)),8&t)return e;if(4&t&&"object"==typeof e&&e&&e.__esModule)return e;var o=Object.create(null);if(n.r(o),Object.defineProperty(o,"default",{enumerable:!0,value:e}),2&t&&"string"!=typeof e)for(var s in e)n.d(o,s,function(t){return e[t]}.bind(null,s));return o},n.n=function(e){var t=e&&e.__esModule?function(){return e.default}:function(){return e};return n.d(t,"a",t),t},n.o=function(e,t){return Object.prototype.hasOwnProperty.call(e,t)},n.p="",n(n.s=0)}([function(e,t,n){"use strict";n.r(t);const o=(e,t="warn")=>{console[t](`[logger]---\x3e${e}`)},s=()=>{},a=e=>JSON.stringify(e),i=(e=15)=>[...Array(e)].join(".").replace(/[.]/g,e=>(e^crypto.getRandomValues(new Uint8Array(1))[0]&15>>e/4).toString(16)),r=(()=>{const e=document.createElement("style");return e.appendChild(document.createTextNode("")),document.head.appendChild(e),e.sheet})(),c=e=>e.constructor===Object,l=async(e,t,n="application/x-www-form-urlencoded")=>{let o;o=c(e)&&"application/x-www-form-urlencoded"===n?f(e):e;const s=new Request(t,{method:"post",headers:{"content-type":n},credentials:"include",body:o});return await fetch(s)},d=e=>e instanceof Function,u=e=>"AsyncFunction"===e.constructor.name,h={q:(e,t=!0)=>{const n=Array.from(document.querySelectorAll(e));return t?n[0]:n},id:e=>document.getElementById(e),className:(e,t=!0)=>{const n=Array.from(document.getElementsByClassName(e));return t?n[0]:n},create:(e,t,n=r)=>{const o=document.createElement(e);if(t&&"object"==typeof t){const e=Object.keys(t);for(const s of e)if("events"===s)for(const e of Object.keys(t[s]))o.addEventListener(e,t[s][e]);else if("style"===s&&n){let e,a=t[s];e=c(a)?b(a):a;const r=i();o.setAttribute("data-rtr-selector",r),n.insertRule(`[data-rtr-selector='${r}']{${e}}`)}else o.setAttribute(s,t[s])}return o},set:(e,t,n)=>e.setAttribute(t,n),empty:e=>{let t;for(t=e.lastChild;t;)e.removeChild(t),t=e.lastChild}},p=async()=>{const e=h.q("meta[name='integrity']"),t=e.getAttribute("content"),n=await l(f({key:t}),"/api/integrity/");let o;try{o=await n.json()}catch(e){console.warn(e)}const s=o.key;return e.setAttribute("content",s),s},g={},y=async()=>{if(g.HERE)return g.HERE;const e=await fetch("/api/getuser",{credentials:"include"});if(!e.ok)return!1;const t=(await e.text()).substr(3);return g.HERE=t,g.HERE},f=e=>`${Object.keys(e).map(t=>`${encodeURIComponent(t)}=${encodeURIComponent(e[t])}`).join("&")}`,m=(e,t={},n={},o=null,s=(()=>{}),a=(()=>{}),i=[],r=null,c=(()=>{}))=>({element:e,attrs:t,beforeRender:s,onrender:a,textContent:o,events:n,children:i,route:r,onUnmount:c}),w=function(e,t={}){let n,o,s,a,i,r,c,l,d,u,p,g,y;d=h.create("div",{class:"notification-box"}),p=h.create("div",{class:"notification-sender"}),g=h.create("div",{class:"notification-text"}),(c=t.hasAction)&&(a=h.create("div",{class:"notification-action-box"}),(i=h.create("div",{class:"notification-action-button"})).textContent=t.actionText||"Example Button",a.appendChild(i)),n=t.body||" ",g.textContent=n,o=t.messageMode,l=t.messageOnClick,g.onclick=p.onclick="__close__"===l?d.onclick=(()=>{h.empty(d),d.remove()}):l,p.textContent=e,o?((s=!!t.mediaURL)&&((y=new Image).src="/static/attachment.svg",h.empty(g),g.appendChild(y)),r=t.chat_id,c&&(i.onclick=(()=>{this._respondToNotification(u,i,r,e,d)}))):c&&(i.onclick=void 0),d.appendChild(p),d.appendChild(g),c&&d.appendChild(a),document.body.appendChild(d),setTimeout(()=>{d.style.marginTop="15px",u=setTimeout(()=>{d.remove()},4e3)},500)},b=e=>{if("string"==typeof e)return e;const t=[];for(const n of Object.keys(e))t.push(`${n}:${e[n]}`);return t.join(";")},_=e=>{try{return Intl.DateTimeFormat("auto",{hour:"numeric",hour12:!0,minute:"numeric",second:"numeric",year:"numeric",month:"numeric",day:"numeric"}).format(new Date(e))}catch(t){return new Date(e).toLocaleString()}},v=()=>(new Date).getTime(),k=(()=>{const e=document.createElement("template"),t=b({margin:"5px",width:"fit-content","border-radius":"15px","max-width":"45%",display:"flex",padding:"6px","margin-top":"5px",color:"#fff",cursor:"pointer","text-align":"left","overflow-wrap":"break-word","word-break":"break-word"});return e.innerHTML=`<style>:host{${t}}</style><slot></slot>`,e})();class x extends HTMLElement{set _id(e){this._id_=e,this.setAttribute("data-msgid",e)}get _id(){return this._id_}constructor(e,t){super();const n=e||k;this.attachShadow({mode:"open"}).appendChild(n.content.cloneNode(!0)),this.meta=null,this.data=null,this._id_=0,t&&(this.meta=t),this._messagedata=null}}const C=e=>new Promise((t,n)=>{const o=new FileReader;o.onload=(e=>t(e.target.result)),o.onerror=(e=>n(e)),o.readAsArrayBuffer(e)}),S=(e,t)=>new Blob([e],{type:t}),R=async e=>{try{const t=await fetch(e),n=await t.blob();return URL.createObjectURL(n)}catch(t){return console.warn(`An error occured while fetching:${e}.Returning ${e} back...`),e}};function E(e){e.style.padding="5px",e.style.opacity=1,e.style.height="auto",e.style.width="auto",e.style.border="2px solid #e3e3e3",e.style.overflow="visible"}const T=e=>{const t=0|e/1048576;if(t)return`${t} MB`;const n=0|e/1024;return n?`${n} KB`:`${e} b`};class ${constructor(e){if(!new URL(e).protocol.includes("ws"))throw new Error(`invalid WebSocket url:${e}`);try{this._kaTimeout=null,this.Socket=new WebSocket(e),this.keepAlivePings=!1}catch(e){throw new Error("could not create a new  WebSocket")}}close(){this._isAlive()&&this.Socket.close()}set onopen(e){this.Socket.onopen=e}set keepAlivePings(e){const t=(e="ping")=>{this.isAlive&&(this.Socket.send(e),this._kaTimeout=setTimeout(t,2e4))};e?t():clearTimeout(this._kaTimeout)}set onmessage(e){this.Socket.onmessage=e}get readyState(){return this.Socket.readyState}_isAlive(){const e=this.Socket;return e instanceof WebSocket&&e.readyState!==e.CLOSED&&e.readyState!==e.CLOSING}get isAlive(){return this._isAlive()}send(e){if(this._isAlive()){if(c(e))return this.Socket.send(JSON.stringify(e));this.Socket.send(e)}}}const D={element:"a",attrs:{href:"/#/",style:{display:"block",color:"#000"}},events:{click(e){e.preventDefault(),location.hash="/"}},textContent:"Click Here to Go Back",children:[]},A={display:"block","text-align":"center","font-family":"sans-serif",padding:"8px",margin:"auto","font-weight":"bold"};class M{constructor(e=h.id("app-root")||h.q("body")){this.root=e,this.unMountFn=(()=>{}),this.routeMap={},this.__socket=null,this.statusHandler={404:{element:"div",attrs:{style:A},textContent:"The Page you are requesting was not found",children:[D]},500:{element:"div",attrs:{style:A},textContent:"An Error Occured while trying to process your request",children:[D]}},this.routes=[],this.routeParser=(e=>{let t,n;if("#"===e[0])t=e.substr(1);else try{t=(n=new URL(e)).hash.substr(1)}catch(e){t="/",console.log(e)}return 0===t.length?"/":t}),window.onhashchange=(()=>{this.routeChange()})}load(e){window.location.href=`${window.location.protocol}//${window.location.host}/#/${e}`}_dataWebsocket(e="/_/data/"){return new Promise(t=>{if(this.__socket&&this.__socket.readyState!==WebSocket.CLOSED&&this.__socket.readyState!==WebSocket.CLOSING)t(this.__socket);else{const n=`${"https:"===window.location.protocol?"wss://":"ws://"}${window.location.host}${e}`,o=new $(n);this.__socket=o,o.onopen=(()=>{o.keepAlivePings=!0,t(o)})}})}startLoad(){this.routeChange()}pushStatus(e,t){const n=this.statusHandler[e];return n.textContent=t||n.textContent,n?this.render(n,this.root,!0):this.render(this.statusHandler[404])}isValidRoute(e){if(this.routes.includes(e))return{res:!0,args:null,_fRoute:e};try{const t=e.split("/").filter(e=>e),n=`/${t[0]}/`;return this.routes.includes(n)?{res:!0,args:t.slice(1),_fRoute:n}:{res:!1}}catch(e){return console.log(e),{res:!1}}}routeChange(){const e=this.routeParser(location.href),{res:t,args:n,_fRoute:o}=this.isValidRoute(e);console.log("rendering"),t?this.render(this.routeMap[o],this.root,!0,n):this.render(this.statusHandler[404],this.root,!0,n)}async render(e,t,n=!1,o=null){const{element:s,attrs:a,beforeRender:i,onrender:c,textContent:l,_innerHTML:p,onUnmount:g,events:y,children:f,isRoute:m}=e;m&&this.unMountFn(),d(i)&&(u(i)?await i(o,this):i(o,this));const w=h.create(s,a,r);l?w.textContent=l:p&&(console.warn("HTMLElement.innerHTML can be dangerous!"),w.innerHTML=p);for(const e of Object.keys(y||{}))w.addEventListener(e,y[e]);for(const e of f||[])this.render(e,w);return n&&h.empty(t),t.appendChild(w),m&&(this.unMountFn=g||(()=>{})),d(c)&&(u(c)?await c(o,this):c(o,this)),w}registerRoute(e,t=!1){if(!e.route||!e.element||"/"!==e.route[0])throw new Error("invalid values");if(!t){this.routes.push(e.route);const{attrs:t,beforeRender:n,children:o,element:s,events:a,hasRouteArgs:i,onUnmount:r,onrender:c,route:l,textContent:d,_innerHTML:u}=e;return this.routeMap[l]={element:s,beforeRender:n,onrender:c,hasRouteArgs:i,attrs:t,textContent:d,_innerHTML:u,events:a,children:o,onUnmount:r,isRoute:!0}}{const t=e.status;this.statusHandler[t]=e}}}const L={login:{fields_empty_or_session_error:"Check Your Username and Password or try to reload the page",no_such_user:"No Such User Exists",incorrect_password:"incorrect password"},register:{fields_empty_or_session_error:"Check Your Username and Password or try to reload the page",bad_request:"Bad Username or Password",username_taken:"Username Already Taken"}},I=e=>{if(0<e.length)return/^[0-9a-zA-Z_.-]+$/.test(e)};const H=e=>{const t=e.value,n=h.id("password-reg").value,o=h.id("__errs__");t===n?(o.style.visibility="hidden",h.empty(o)):(o.style.visibility="visible",o.innerHTML="Passwords Do Not Match!")};const O=m("button",{id:"login",style:{"background-color":"#fff","border-radius":"5px",padding:"4px",border:"1px solid #6200ee",outline:"0",color:"#6200ee","text-transform":"uppercase",width:"80px",height:"30px",margin:"10px",cursor:"pointer"}},{click:function(e){const t=e.target;t.style.backgroundColor="#6200ee",t.style.color="#fff";const n=h.id("signup");n.style.backgroundColor="#fff",n.style.color="#6200ee",h.id("lfbox").style.display="block",h.id("rfbox").style.display="none"}},"Login");const U=m("button",{id:"signup",style:{color:"#6200ee","border-radius":"5px",padding:"4px",border:"1px solid #6200ee",outline:"0","background-color":"#fff","text-transform":"uppercase",width:"80px",height:"30px",margin:"10px",cursor:"pointer"}},{click:function(e){const t=e.target;t.style.backgroundColor="#6200ee",t.style.color="#fff";const n=h.id("login");n.style.backgroundColor="#fff",n.style.color="#6200ee",h.id("rfbox").style.display="block",h.id("lfbox").style.display="none"}},"Signup"),N=m("div",{id:"register-form"},null,null,null,null,[m("div",{id:"__errs__",style:{color:"red",visibility:"hidden",height:"20px"}}),m("input",{class:"input_x",id:"username-reg",placeholder:"username"},{input({target:e}){const t=h.id("errors-and-notices");h.empty(t),function(e){const t=h.id("__errs__");h.empty(t);const n=e.value,o=h.id("password-reg"),s=h.id("password-reg-conf");I(n)?4>n.length?(t.style.visibility="visible",t.innerHTML="Username Too Short",o.disabled=!0,s.disabled=!0):30<n.length?(t.style.visibility="visible",t.innerHTML="Username Too Long",o.disabled=!0,s.disabled=!0):(o.disabled=!1,s.disabled=!1):(t.style.visibility="visible",t.innerHTML="Invalid Characters!",o.disabled=!0,s.disabled=!0)}(e)},keydown(e){13===e.keyCode&&h.id("password-reg").focus()}}),m("input",{class:"input_x",id:"password-reg",placeholder:"Password",type:"password"},{input(){const e=h.id("password-reg-conf");0<e.value.length&&H(e)},keydown(e){13===e.keyCode&&h.id("password-reg-conf").focus()}}),m("input",{class:"input_x",id:"password-reg-conf",placeholder:"Password",type:"password"},{keydown(e){13===e.keyCode&&h.id("register-btn").click()},input({target:e}){H(e)}})]);const j=m("button",{class:"submit-button",id:"register-btn"},{click:async function(){const e=h.id("password-reg"),t=h.id("username-reg"),n=h.id("password-reg-conf"),o=e.value,s=n.value,a=h.id("errors-and-notices");if(o!==s)return a.textContent="Passwords Do not Match!";{a.textContent="Loading";const e=await fetch("/register/check/",{credentials:"include",headers:{"content-type":"application/x-www-form-urlencoded"},method:"post",body:f({user:t.value,password:o,checkpw:s,integrity:await p()})});try{const t=await e.json();if(403===e.status){const e=L.register[t.error];a.innerHTML=e}else 200!==e.status?a.innerHTML="An Error Occured..please reload the page and try again":a.innerHTML="Account Created. Please Login"}catch(e){return console.log(e),a.innerHTML="An Error Occured..please reload the page and try again"}}}},"Signup"),P=m("div",{id:"login-form"},null,null,null,null,[m("input",{class:"input_x",id:"username-log",placeholder:"username"},{keydown(e){13===e.keyCode&&h.id("password-log").focus()}}),m("input",{class:"input_x",id:"password-log",placeholder:"Password",type:"password"},{keydown(e){const t=e.target,n=h.id("username-log");0!==t.value.length&&0!==n.value.length&&13===e.keyCode&&h.id("login-btn").click()}})]);const B=m("button",{class:"submit-button",id:"login-btn"},{click:async function(){const e=h.id("errors-and-notices");e.innerHTML="Loading";const t=await fetch("/login/check/",{credentials:"include",method:"post",headers:{"content-type":"application/x-www-form-urlencoded"},body:f({user:h.id("username-log").value,password:h.id("password-log").value,integrity:await p()})});try{const n=await t.json();if(403===t.status){const t=L.login[n.error];e.innerHTML=t}else{if(200===t.status)return e.textContent="Authenticated",location.hash=`/u/${n.user}`,document.title=`${n.user} - WebMsg`;e.innerHTML="An Error Occured..please reload the page and try again"}}catch(t){return console.log(t),e.innerHTML="An Error Occured..please reload the page and try again"}}},"Login"),W=m("div",{id:"rfbox",style:b({display:"none"})},null,null,null,null,[N,j]),z=m("div",{id:"lfbox",style:b({display:"none"})},null,null,null,null,[P,B]),F=m("div",{class:"main"},null,null,async()=>{const e=await y();if(!e)return null;console.log(`[Routing]->/u/${e}`),location.hash=`/u/${e}`,document.title=`${e} - WebMsg`},async()=>{console.log("Rendered login page"),document.title="Login - WebMsg"},[O,U,m("div",{id:"errors-and-notices",style:b({color:"red"})}),z,W],"/");const q=m("div",null,null,null,null,null,[m("div",{id:"messages",style:{height:"20px",color:"red",visibility:"hidden"}}),m("input",{id:"users",class:"input_n",placeholder:"Search for a User"},{keydown(e){13===e.keyCode&&h.id("sbm").click()}}),m("button",{id:"sbm",class:"submit-button"},{async click(){const e=h.id("users"),t=h.id("messages");if(t.style.visibility="hidden",0!==e.value.length){const n=h.id("resbox-details"),o=h.id("loading-gif");o.style.display="inline",n.style.display="block";const s=await fetch(`/api/user-search/tokens/${await p()}`,{method:"get",credentials:"include"}),a=await s.text(),i=await l(f({token:a,user:e.value}),"/api/users/");o.style.display="none",n.style.display="none";try{return function(e){const t=e.users,n=h.id("results-all");n.style.display="block",h.empty(n);const o=document.createElement("div");if(o.textContent="Search Results",n.appendChild(o),0===t.length)return o.innerHTML="No Results Found";h.empty(n);for(const e of t){const t=h.create("a",{style:{"text-decoration":"none",color:"#000",display:"block"},"data-user":e.user,title:e.user,"data-chat_id":e.chat_id}),o=h.create("button");o.textContent=e.user,t.appendChild(o),t.href=`/#/chat/${e.chat_id}`,o.className="resbtn",n.appendChild(t)}}(await i.json())}catch(e){return t.style.visibility="visible",t.innerHTML="An error occured on our end..please try again",console.warn(e)}}}},"Search"),m("div",{id:"errmsgs"})]),K=m("div",{class:"results",id:"res"},null,null,null,null,[m("div",{id:"resbox-details",style:{"margin-top":"20px"}},null,null,null,null,[m("img",{id:"loading-gif",class:"loading-gif",src:"/static/loading.gif"})])]),Y=m("div",{class:"box-s"},null,null,async(e,t)=>{let n;if(e.length>1)return console.log("Unusable args"),location.hash=`/u/${e[0]}`;const o=await y();if(!o)return console.log("Not Logged In"),location.hash="/";if(0===e.length)return location.hash=`/u/${o}`;if(o!==(n=e[0]))return location.hash=location.hash.replace(n,o);const s=t.root;h.empty(s),s.textContent="Loading"},async(e,t)=>{document.title=`${e[0]} - WebMsg`;const n=await l(`user=${encodeURIComponent(await y())}`,"/api/chat_ids/"),o=await n.json(),s=h.id("prev-chats");if(!s)return;s.innerHTML="<div>Your Previous Chats</div>";const a=o.previous_chats;if(0===a.length)return s.innerHTML="No previous chats Found";for(const e of a){const t=h.create("div",{"data-user":e.user,title:e.user,"data-chat_id":e.chat_id}),n=h.create("button",{class:"resbtn"});n.textContent=e.user,t.appendChild(n),n.onclick=(()=>{location.href=`${window.location.protocol}//${location.host}/#/chat/${e.chat_id}`}),s.appendChild(t)}await t._dataWebsocket()},[m("div",{class:"main"},null,null,null,null,[q,K,m("div",{id:"results-all"}),m("div",{id:"prev-chats"})])],"/u/"),G=()=>{const e=h.id("Nzk3NzEzOD");"opened"===h.id("__menubox__").getAttribute("data-stat")&&e.click()},J=()=>{const e=document.getElementById("__menubox__");return"closed"==e.getAttribute("data-stat")?(h.set(e,"data-stat","opened"),void(e.style.marginBottom="0px")):(h.set(e,"data-stat","closed"),e.style.marginBottom="-250px")},V=(e,t,n,o,s)=>{const a=h.id("results-all");h.empty(a),a.style.display="block",t.render(((e,t,n,o)=>{return{element:"div",attrs:{class:"chat_box_wrap"},children:[{element:"div",attrs:{class:"chat_box"},children:[{element:"div",attrs:{class:"chat_head"},children:[{element:"span",textContent:"â˜°",events:{click:J},attrs:{class:"menubox",id:"Nzk3NzEzOD"}},{element:"span",attrs:{id:"__chat-with-prof",class:"chat_with"},textContent:e}]},{element:"div",attrs:{id:"__menubox__","data-stat":"closed",class:"menu-details"},children:[{element:"div",attrs:{class:"img-button-holder"},textContent:"Add An Attachment",events:{click(e){e.stopPropagation(),n(e)}}},{element:"div",attrs:{class:"img-button-holder"},textContent:"Close Conversation",events:{async click(e){e.stopPropagation();const t=await y();return t?location.hash=`/u/${t}`:"/"}}},{element:"div",attrs:{class:"img-button-holder"},textContent:"Logout",events:{click(e){e.stopPropagation(),o(e)}}}]},{element:"div",attrs:{class:"chat_body",id:"_msg_body"},events:{click:G}},{element:"input",attrs:{type:"text",placeholder:"Type a Message",class:"chat_inp"},events:{keydown:t},children:[]}]}]}})(e,n,o,s),a,!0)},Q={chatID:"",messageCache:{},USERS:{},lastMsgID:-1},Z=()=>h.id("_msg_body");let X;const ee=(e,t)=>{if(13===e.keyCode){const n=e.target;if(n.value.replace(/\s/g,"").length>0){const e=n.value||h.className("chat_inp").value;Q.lastMsgID+=1;const o={sender:Q.USERS.HERE,receiver:Q.USERS.THERE,data:e,typing:!1,stamp:v(),_id:Q.lastMsgID};he(t,o),ae(o,!0),n.value=""}}else he(t,{sender:Q.USERS.HERE,receiver:Q.USERS.THERE,data:null,typing:!0,stamp:v()})};window.customElements.define("text-message",x);const te=(e,t)=>{const{name:n,size:o}=e,s=e.type||"application/octet-stream",a=new FileReader;a.onload=(()=>he(t,a.result,!0,{name:n,type:s,size:o})),a.readAsArrayBuffer(e)};async function ne(e){const{dataChannel:t,app:n,HERE:o,chat:s,pc:a}=e;h.id("results-all").textContent="Loading a Secure Session",V(s,n,(e=>t=>ee(t,e))(t),(e=>()=>(function(e){const t=h.create("input",{type:"file"});t.oninput=(t=>{const n=t.target;return te(n.files[0],e)}),t.click(),Z().click()})(e))(t),((e,t)=>()=>(ue(e,t),location.href="/logout"))(a,t))}const oe=async e=>{const t=h.id("start_chat");t&&t.remove();const{dataChannel:n,pc:o,app:s,chat:a,chatID:i}=e;n.onmessage=de,function(e,t){e.oniceconnectionstatechange=(n=>{const o=e.iceConnectionState;["closed","disconnected","failed"].includes(o)&&(console.log("Connection is Dead.."),t&&"function"==typeof t.close&&t.close(),e.close())})}(o,n),X=o;const r=await y(),c=a;e.HERE=r,Q.USERS={HERE:r,THERE:c},Q.chatID=i,await ne(e),await async function(e,t,n){Q.lastMsgID=-1,console.log("Rendering Messages from IDB");const o=await async function(e,t){const n=await window.$get(e);return n||t&&w("No IndexedDB Support Found",{body:"This website stores messages within your browsers database.",messageOnClick:"__close__"}),n||{}}(e,!1);Z().style.visibility="none";for(const e of Object.keys(o)){const t=o[e];ae(t,!1)}Z().style.visibility="visible"}(i)};function se(e){return e!==Q.USERS.THERE&&(!(e!==Q.USERS.HERE)||void 0)}function ae(e,t){const{binary:n,data:s,name:a,read:i,receiver:r,rstamp:c,sender:l,size:d,stamp:u,type:p,typing:g}=e;let y,f,m;if(m=e._id,i)return console.log("Handle Read..");if(g)return function(e,t=h.id("__chat-with-prof")){clearTimeout(pe),e===Q.USERS.THERE&&t&&(t.textContent=`${e} is typing...`,pe=setTimeout(()=>{t.textContent=e,pe=void 0},700))}(l);if(!s&&!n)return o("Bad arguments");if(f=new x,se(l)?m=Q.lastMsgID:Q.lastMsgID++,console.log(`Cached ID:${Q.lastMsgID}\nmsgid:${m}`),m!==Q.lastMsgID&&console.log("Bad IDB storage on one side"),f._id=Q.lastMsgID,s&&!n)f.textContent=s;else if(n){console.log(e),f._messagedata=s;const t=document.createTextNode(`File:${a} Size:${T(d)} type:${p}`),n=new Image;f.appendChild(n),R("/static/attachment.svg").then(e=>n.src=e),f.style.fontSize="12px",f.appendChild(t)}f.meta={binary:n,name:a,read:i,receiver:r,rstamp:c,sender:l,size:d,stamp:u,type:p};const w=se(l);if(void 0===w)return console.warn("Invalid args!",e);y=w?"msg_sent":"msg_received",f.className=y,f.onclick=(e=>{!function(e){function t(e,t){E(e),function(e){e.style.overflow="hidden",e.style.padding="0px",e.style.opacity=0,e.style.height="0",e.style.border="none",e.style.width="0"}(t)}const n=h.id("message-info"),o=e.meta;h.empty(n),n.style.opacity="1";const s=h.create("div",{class:"message-close",events:{click(){a.style.opacity="0",a.style.height="0px",n.style.opacity="0",h.empty(n)}}});s.textContent="Close";const a=h.create("div",{style:{transition:"0.3s ease-in-out"}});n.appendChild(s),n.appendChild(a);const i=h.create("div",{class:"message-info-key","data-slide":"out"}),r=h.create("div",{class:"message-info-value"}),c=h.create("div",{class:"message-info-key","data-slide":"out"}),l=h.create("div",{class:"message-info-value"}),d=h.create("div",{class:"message-info-key","data-slide":"out"}),u=h.create("div",{class:"message-info-value"});i.onclick=(()=>{t(r,i)}),r.onclick=(()=>{t(i,r)}),c.onclick=(()=>{t(l,c)}),l.onclick=(()=>{t(c,l)}),d.onclick=(()=>{t(u,d)}),u.onclick=(()=>{t(d,u)}),i.textContent="Sender";const p=o.sender,g=o.stamp,y=o.read,f=o.rstamp,m=Q.USERS.HERE;r.textContent=p+(p===m?"(You)":"");const w=o.binary;d.textContent="Time",u.textContent=_(g),c.textContent="Read-Status",l.textContent="true"===y?`Read (${isNaN(f)?"N/A":_(f)})`:"Sent",p!==m&&(c.style.display="none",l.style.display="none");if(w){const t=h.create("div"),n=h.create("div");h.set(t,"class","message-info-key"),h.set(n,"class","message-info-value"),t.textContent="Media Message",n.textContent="Click To Open Media Preview",n.style.cursor="pointer",h.set(n,"data-media",w),E(n),n.onclick=(()=>{const t=o,n=new Image;n.onerror=(()=>{n.style.display="none"});const s=URL.createObjectURL(S(e._messagedata,t.type));n.src=s,a.innerHTML="";const i=h.create("a");a.appendChild(n),a.appendChild(i),i.style.color="black",i.style.textDecoration="none",i.target="__blank",i.style.display="block",i.textContent="Click To Open Media In A New Tab",i.href=s,n.style.width="160px",n.style.height="100px"}),a.appendChild(t),a.appendChild(n)}n.style.display="block",a.appendChild(i),a.appendChild(r),a.appendChild(d),a.appendChild(u),a.appendChild(c),a.appendChild(l),console.log(o)}(e.target)});const b=Z();return b.appendChild(f),b.scrollTop=b.scrollHeight,t?async function(e){const t=window.$get,n=window.$set,o=Q.chatID,s=await t(o)||{},a=e._id;if(s[a])return console.warn("Message Already in database!");return s[a]=e,console.log("setting database")||await n(o,s)}(e):void 0}let ie,re,ce,le;function de(e){const t=e.target,n=e.data;if("__next__"===n)return;if(ie&&"string"!=typeof n)return function(e){const n=new Uint8ClampedArray(e);if(re.set(n,le),(le+=n.byteLength)===re.byteLength)return o("Data Received!"),ae({...ce,data:re.buffer,binary:!0},!0),void(le=ie=re=ce=void 0);t.send("__next__")}(n);let s;try{if((s=JSON.parse(n)).__close__)return o("User Left the chat.."),t.close(),void X.close();if(206===parseInt(s.dataType)){const{len:e,meta:t}=s;return o(`expecting binary data with length ${e}`,"log"),ie=!0,le=0,ce=t,void(re=new Uint8ClampedArray(e))}ae(s,!0)}catch(n){return console.warn(n),console.log("^^^",e)}}const ue=(e,t)=>{t&&console.log(`Destroying Session..from readystate->${t.readyState}`),(async(e,t)=>{const n=await y();try{t&&"function"==typeof t.send&&t.send(a({data:null,__close__:!0}))}catch(e){o(`Couldnt send closing message--\x3e${e}`)}void 0!==e&&void 0!==t&&(t.onclose=e.onclose=(()=>{o("Destroying Conversation","log")}),t.close(),e.close()),location.hash=n?`/u/${n}`:"/"})(e,t)};async function he(e,t,n=!1,s){if(!t)return;let i;if(n){if(t instanceof ArrayBuffer)i=t;else{if(!(t instanceof Blob))throw new Error("Invalid Binary Type");i=await C(t)}return async function(e,t,n){const s=t.byteLength,i=parseInt(s/65e3),r=e.onmessage;e.onmessage=(()=>null);const c=()=>new Promise(t=>{e.onmessage=(e=>t(e))});Q.lastMsgID+=1;const l={...n,sender:Q.USERS.HERE};e.send(a({dataType:206,len:s,_id:Q.lastMsgID,meta:l}));const d=new Uint8Array(t);for(let t=0;t<i;t++){const n=65e3*t,o=n+65e3,s=d.subarray(n,o);e.send(s);const a=await c();"__next__"!==a.data&&(console.log("Unknown message"),r(a))}const u=s%65e3;u&&(o(`last ${u} byte(s)`,"log"),e.send(d.subarray(65e3*i))),e.onmessage=r,ae({...l,binary:!0,data:d.buffer},!0)}(e,i,s)}if(i=c(t)?a(t):t)return e.send(i);throw new Error("No Data To Send")}let pe,ge,ye,fe,me,we;const be={iceServers:[{urls:"stun:stun.l.google.com:19302"}]},_e={websockets:[],chatWith:"",_functions:{}};function ve(e){if(!ye)return console.log("no active connections found to a websocket");ye.send(e)}function ke(){console.log("TODO:Add Notification");const e=we||_e.chatWith,t=h.id("start_chat");if(t){h.empty(t),t.appendChild((()=>{const t=h.create("div");return t.textContent=`waiting for ${e} to come online`,t})());const n=h.create("img",{class:"loading-gif",style:{display:"block",margin:"auto"}});t.appendChild(n),R("/static/loading.gif").then(e=>n.src=e)}}const xe=async({candidate:e},t)=>{e&&await ve({sendTo:t,rtcData:{candidate:e}})};function Ce(){ke(),ve("ping"),ve({sendTo:we,isOfferer:!!me})}function Se(){if(fe&&ge&&_e.chatWith)return{dataChannel:fe,pc:ge,chat:_e.chatWith,app:_e.__app,chatID:_e.__chatID}}async function Re(e){if(e){(ge=new RTCPeerConnection(be)).onicecandidate=(e=>xe(e,we)),fe=ge.createDataChannel(i()),console.log("new Data Channel",fe),fe.onmessage=(e=>(function(e){"__ping__"===e.data&&(document.title=`WebMsg ${_e.chatWith?`Chat With - ${_e.chatWith}`:""}`,oe(Se()))})(e)),fe.onclose=fe.onerror=(()=>{ge=fe=me=void 0,console.log("data channel closed"),Te()});const e=await ge.createOffer();await ge.setLocalDescription(e),ve({rtcData:ge.localDescription,sendTo:we})}}const Ee=async(e,t)=>{const n=e.data;if("pong"===n)return;if("ping"===n)return ve("ping");const s=JSON.parse(n),{_status:a,get_status:i,checkOfferer:r,restart:c,rtcData:d,sendTo:u,set_role:h}=s;if(t=t||u||_e.chatWith,r)return ve({sendTo:t,isOfferer:!!me});if(h&&"boolean"!=typeof me)return me=h,await Re(me);if(d)await async function(e,t){const{rtcData:n,sendTo:s}=e;t!==s&&(o(t,s),o("Multiple RTC Connections Not Supported on the Same Page")),"offer"===n.type?(void 0===ge&&((ge=new RTCPeerConnection(be)).onicecandidate=(e=>xe(e,t)),ge.ondatachannel=(e=>{(fe=e.channel).onclose=fe.onerror=(e=>{ge=fe=me=void 0,console.log("datachannel Closed"),Te()}),fe.send("__ping__"),console.log("Created a Data Channel",e),oe(Se())})),await ge.setRemoteDescription(n),await ge.setLocalDescription(await ge.createAnswer()),await ve({rtcData:ge.localDescription,sendTo:t})):"answer"===n.type?(console.log("--\x3e",ge),await ge.setRemoteDescription(n)):n.candidate&&await ge.addIceCandidate(n.candidate)}(s,t);else{if(a)return ve({sendTo:t,_set_status:!0,RB:s.RB,dataChannel:void 0!==fe});c?(ge&&fe&&"open"===fe.readyState&&(fe.onclose=(()=>{o("closing data channel","log")}),fe.close(),ge.close(),ge=fe=me=void 0),ge=fe=me=void 0,me=void 0,Ce()):i&&(s.isOn&&u===_e.chatWith?ve({requestRestart:!0,sendTo:u}):(w(`Requesting ${u} for a chat session`,{body:" ",messageOnClick:"__close__"}),l({user:_e.chatWith},"/api/request-chat/")))}};function Te(){o("Attempting to start a webrtc connection...","log");const e=_e.chatWith;$e(e,_e.__app),ke(),ve({_get_status:!0,sendTo:e})}function $e(e,t){const n=h.id("main-chat-box"),o=m("div",{id:"start_chat",style:{height:"20%","overflow-wrap":"break-word","background-color":"#fff",width:"40%",display:"block",position:"absolute",margin:"auto",top:"0",left:"0",right:"0",bottom:"0",border:"2px solid #e3e3e3","border-radius":"15px","box-shadow":"2px 2px 2px 2px #e3e3f0","text-align":"center","flex-wrap":"wrap","align-items":"center",padding:"8px","justify-content":"center"}},null,null,null,()=>{h.id("start_chat").style.height="fit-content"},[m("div",{style:{"font-weight":"bold"}},null,`Start Chat Session with ${e}`),m("div",null,null,"No ongoing chat session detected. Press the button to start a session"),m("button",{style:{"border-radius":"5px",height:"auto"},class:"resbtn"},{click:Ce},"Start")]);t.render(o,n)}const De=m("div",{id:"main-chat-box",class:"box-s"},null,null,async(e,t)=>{let n;return await y()?e?1<e.length?(console.log("Unusable Args"),n=e[0],location.hash=`/chat/${n}`):1>e.length?await t.pushStatus(500):void 0:await t.pushStatus(500):(console.log("Not Logged In"),location.hash="/")},async(e,t)=>{const n=e[0];_e.__chatID=n;const o=await(async e=>{const t=await l(f({chat_id:e}),"/api/validate-chat/"),n=await t.json();return!n.hasOwnProperty("error")&&n})(n);if(!o)return t.pushStatus(500,"the chat id you provided is invalid. please try again");we=o.chat_with,_e.__app=t,_e.chatWith=we,(ye=await(async e=>{const t=await e._dataWebsocket(),n=_e.websockets;return n&&(n.forEach(e=>{"function"==typeof e.close&&e.close()}),_e.websockets.length=0),_e.websockets.push(t),t})(t)).onmessage=Ee;const s=await(async e=>{const t=await l(f({user:e}),"/api/get-userstats/");return"online"===(await t.json()).status})(_e.chatWith);console.log(`${we} is Online--\x3e:${s}`),s?Te():await $e(_e.chatWith,t)},[m("div",{class:"main"},null,null,null,null,[m("div",{id:"results-all"}),m("div",{class:"message-info",id:"message-info"})])],"/chat/",function(){console.log("Unmounting"),me=we=void 0,_e.websockets.forEach(e=>{"function"==typeof e.close&&e.close()});for(const e of Object.keys(_e._functions))_e._functions[e]=s;Object.keys(_e).forEach(e=>{delete _e[e]}),_e.websockets=[],_e._functions={},_e.chatWith=null,ue(ge,fe)}),Ae=()=>{if(window.indexedDB){class e{constructor(e="WebCache",t="KeyStore"){this.storeName=t,this._dbase=new Promise((n,o)=>{const s=indexedDB.open(e,1);s.onerror=(()=>{n(null)}),s.onsuccess=(()=>{n(s.result)}),s.onupgradeneeded=(()=>{s.result.createObjectStore(t)})})}__IDBAct__(e,t){return this._dbase.then(n=>new Promise((o,s)=>{const a=n.transaction(this.storeName,e);a.oncomplete=(()=>o()),a.onabort=a.onerror=(()=>s()),t(a.objectStore(this.storeName))})).catch(e=>console.log(e)||null)}}let t;const n=()=>t||new e;window.$get=((e,t=n())=>{let o;return t.__IDBAct__("readonly",t=>{o=t.get(e)}).then(()=>o.result).catch(e=>console.log(e)||null)}),window.$set=((e,t,o=n())=>{try{return o.__IDBAct__("readwrite",n=>{n.put(t,e)})}catch(e){return null}}),window.$del=((e,t=n())=>{try{t.__IDBAct__("readwrite",t=>{t.delete(e)})}catch(e){return null}}),window.$__clear__=((e=n())=>{try{return console.warn("clearing Store:",e),e.__IDBAct__("readwrite",e=>{e.clear()})}catch(e){return e}}),window.$keys=((e=n())=>{const t=[];return e.__IDBAct__("readonly",e=>{(e.openKeyCursor||e.openCursor).call(e).onsuccess=function(){this.result&&(t.push(this.result.key),this.result.continue())}}).then(()=>t).catch(e=>null)})}else{const e=async()=>null;window.$get=window.$set=window.$keys=window.$__clear__=window.$del=e}};(async()=>{Ae();try{(()=>{if(window.Notification){if("undefined"==typeof firebase)throw new Error("hosting/init-error: Firebase SDK not detected. You must include it before /__/firebase/init.js");firebase.initializeApp({apiKey:"AIzaSyCrdjBktQNWizVmfjK50I7BGsIQcNFmKcI",databaseURL:"https://webmsg-py.firebaseio.com",storageBucket:"webmsg-py.appspot.com",authDomain:"webmsg-py.firebaseapp.com",messagingSenderId:"193257233140",projectId:"webmsg-py"})}})()}catch(e){console.log(e)}const e=new M(h.id("app-root")||document.body);e.registerRoute(F),e.registerRoute(Y),e.registerRoute(De),e.registerRoute(Object.assign({},{route:"/_500/"},e.statusHandler[500])),e.startLoad()})()}]);