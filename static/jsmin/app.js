!function(e){var t={};function n(o){if(t[o])return t[o].exports;var s=t[o]={i:o,l:!1,exports:{}};return e[o].call(s.exports,s,s.exports,n),s.l=!0,s.exports}n.m=e,n.c=t,n.d=function(e,t,o){n.o(e,t)||Object.defineProperty(e,t,{enumerable:!0,get:o})},n.r=function(e){"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(e,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(e,"__esModule",{value:!0})},n.t=function(e,t){if(1&t&&(e=n(e)),8&t)return e;if(4&t&&"object"==typeof e&&e&&e.__esModule)return e;var o=Object.create(null);if(n.r(o),Object.defineProperty(o,"default",{enumerable:!0,value:e}),2&t&&"string"!=typeof e)for(var s in e)n.d(o,s,function(t){return e[t]}.bind(null,s));return o},n.n=function(e){var t=e&&e.__esModule?function(){return e.default}:function(){return e};return n.d(t,"a",t),t},n.o=function(e,t){return Object.prototype.hasOwnProperty.call(e,t)},n.p="",n(n.s=0)}([function(e,t,n){"use strict";n.r(t);const o=()=>{},s=e=>JSON.stringify(e),r=(e=15)=>[...Array(e)].join(".").replace(/[.]/g,e=>(e^crypto.getRandomValues(new Uint8Array(1))[0]&15>>e/4).toString(16)),i=(()=>{const e=document.createElement("style");return e.appendChild(document.createTextNode("")),document.head.appendChild(e),e.sheet})(),a=e=>e.constructor===Object,l=async(e,t,n="application/x-www-form-urlencoded")=>{let o;o=a(e)&&"application/x-www-form-urlencoded"===n?y(e):e;const s=new Request(t,{method:"post",headers:{"content-type":n},credentials:"include",body:o});return await fetch(s)},c=e=>e instanceof Function,d=e=>"AsyncFunction"===e.constructor.name,u={q:(e,t=!0)=>{const n=Array.from(document.querySelectorAll(e));return t?n[0]:n},id:e=>document.getElementById(e),className:(e,t=!0)=>{const n=Array.from(document.getElementsByClassName(e));return t?n[0]:n},create:(e,t,n)=>{const o=document.createElement(e);if(t&&"object"==typeof t){const e=Object.keys(t);for(const s of e)if("events"===s)for(const e of Object.keys(t[s]))o.addEventListener(e,t[s][e]);else if("style"===s&&n){let e,i=t[s];e=a(i)?w(i):i;const l=r();o.setAttribute("data-rtr-selector",l),n.insertRule(`[data-rtr-selector='${l}']{${e}}`)}else o.setAttribute(s,t[s])}return o},set:(e,t,n)=>e.setAttribute(t,n),empty:e=>{let t;for(t=e.lastChild;t;)e.removeChild(t),t=e.lastChild}},h=async()=>{const e=u.q("meta[name='integrity']"),t=e.getAttribute("content"),n=await l(y({key:t}),"/api/integrity/");let o;try{o=await n.json()}catch(e){console.warn(e)}const s=o.key;return e.setAttribute("content",s),s},p={},g=async()=>{if(p.HERE)return p.HERE;const e=await fetch("/api/getuser",{credentials:"include"});if(!e.ok)return!1;const t=await e.text();return p.HERE=t,p.HERE},y=e=>`${Object.keys(e).map(t=>`${encodeURIComponent(t)}=${encodeURIComponent(e[t])}`).join("&")}`,f=(e,t={},n={},o=null,s=(()=>{}),r=(()=>{}),i=[],a=null,l=(()=>{}))=>({element:e,attrs:t,beforeRender:s,onrender:r,textContent:o,events:n,children:i,route:a,onUnmount:l}),w=e=>{if("string"==typeof e)return e;const t=[];for(const n of Object.keys(e))t.push(`${n}:${e[n]}`);return t.join(";")},b={element:"a",attrs:{href:"/#/",style:{display:"block",color:"#000"}},events:{click(e){e.preventDefault(),location.hash="/"}},textContent:"Click Here to Go Back",children:[]},m={display:"block","text-align":"center","font-family":"sans-serif",padding:"8px",margin:"auto","font-weight":"bold"};const _={login:{fields_empty_or_session_error:"Check Your Username and Password or try to reload the page",no_such_user:"No Such User Exists",incorrect_password:"incorrect password"},register:{fields_empty_or_session_error:"Check Your Username and Password or try to reload the page",bad_request:"Bad Username or Password",username_taken:"Username Already Taken"}},v=e=>{if(0<e.length)return/^[0-9a-zA-Z_.-]+$/.test(e)};const k=e=>{const t=e.value,n=u.id("password-reg").value,o=u.id("__errs__");t===n?(o.style.visibility="hidden",u.empty(o)):(o.style.visibility="visible",o.innerHTML="Passwords Do Not Match!")};const x=f("button",{id:"login"},{click:function(e){const t=e.target;t.style.backgroundColor="#6200ee",t.style.color="#fff";const n=u.id("signup");n.style.backgroundColor="#fff",n.style.color="#6200ee",u.id("lfbox").style.display="block",u.id("rfbox").style.display="none"}},"Login");const C=f("button",{id:"signup"},{click:function(e){const t=e.target;t.style.backgroundColor="#6200ee",t.style.color="#fff";const n=u.id("login");n.style.backgroundColor="#fff",n.style.color="#6200ee",u.id("rfbox").style.display="block",u.id("lfbox").style.display="none"}},"Signup"),$=f("div",{id:"register-form"},null,null,null,null,[f("div",{id:"__errs__"}),f("input",{class:"input_x",id:"username-reg",placeholder:"username"},{input({target:e}){const t=u.id("errors-and-notices");u.empty(t),function(e){const t=u.id("__errs__");u.empty(t);const n=e.value,o=u.id("password-reg"),s=u.id("password-reg-conf");v(n)?4>n.length?(t.style.visibility="visible",t.innerHTML="Username Too Short",o.disabled=!0,s.disabled=!0):30<n.length?(t.style.visibility="visible",t.innerHTML="Username Too Long",o.disabled=!0,s.disabled=!0):(o.disabled=!1,s.disabled=!1):(t.style.visibility="visible",t.innerHTML="Invalid Characters!",o.disabled=!0,s.disabled=!0)}(e)},keydown(e){13===e.keyCode&&u.id("password-reg").focus()}}),f("input",{class:"input_x",id:"password-reg",placeholder:"Password",type:"password"},{input(){const e=u.id("password-reg-conf");0<e.value.length&&k(e)},keydown(e){13===e.keyCode&&u.id("password-reg-conf").focus()}}),f("input",{class:"input_x",id:"password-reg-conf",placeholder:"Password",type:"password"},{keydown(e){13===e.keyCode&&u.id("register-btn").click()},input({target:e}){k(e)}})]);const R=f("button",{class:"submit-button",id:"register-btn"},{click:async function(){const e=u.id("password-reg"),t=u.id("username-reg"),n=u.id("password-reg-conf"),o=e.value,s=n.value,r=u.id("errors-and-notices");if(o!==s)return r.textContent="Passwords Do not Match!";{r.textContent="Loading";const e=await fetch("/register/check/",{credentials:"include",headers:{"content-type":"application/x-www-form-urlencoded"},method:"post",body:y({user:t.value,password:o,checkpw:s,integrity:await h()})});try{const t=await e.json();if(403===e.status){const e=_.register[t.error];r.innerHTML=e}else 200!==e.status?r.innerHTML="An Error Occured..please reload the page and try again":r.innerHTML="Account Created. Please Login"}catch(e){return console.log(e),r.innerHTML="An Error Occured..please reload the page and try again"}}}},"Signup"),L=f("div",{id:"login-form"},null,null,null,null,[f("input",{class:"input_x",id:"username-log",placeholder:"username"},{keydown(e){13===e.keyCode&&u.id("password-log").focus()}}),f("input",{class:"input_x",id:"password-log",placeholder:"Password",type:"password"},{keydown(e){const t=e.target,n=u.id("username-log");0!==t.value.length&&0!==n.value.length&&13===e.keyCode&&u.id("login-btn").click()}})]);const S=f("button",{class:"submit-button",id:"login-btn"},{click:async function(){const e=u.id("errors-and-notices");e.innerHTML="Loading";const t=await fetch("/login/check/",{credentials:"include",method:"post",headers:{"content-type":"application/x-www-form-urlencoded"},body:y({user:u.id("username-log").value,password:u.id("password-log").value,integrity:await h()})});try{const n=await t.json();if(403===t.status){const t=_.login[n.error];e.innerHTML=t}else{if(200===t.status)return e.textContent="Authenticated",location.hash=`/u/${n.user}`,document.title=`${n.user} - WebMsg`;e.innerHTML="An Error Occured..please reload the page and try again"}}catch(t){return console.log(t),e.innerHTML="An Error Occured..please reload the page and try again"}}},"Login"),j=f("div",{id:"rfbox",style:w({display:"none"})},null,null,null,null,[$,R]),A=f("div",{id:"lfbox",style:w({display:"none"})},null,null,null,null,[L,S]),M=f("div",{class:"main"},null,null,async()=>{const e=await fetch("/api/getuser",{credentials:"include"});if(!e.ok)return null;const t=await e.text();console.log("[Routing]->/u/"+t),location.hash="/u/"+t,document.title=t+" - WebMsg"},async()=>{console.log("Rendered login page"),document.title="Login - WebMsg"},[x,C,f("div",{id:"errors-and-notices",style:w({color:"red"})}),A,j],"/");const T=f("div",null,null,null,null,null,[f("div",{id:"messages",style:{height:"20px",color:"red",visibility:"hidden"}}),f("input",{id:"users",class:"input_n",placeholder:"Search for a User"},{keydown(e){13===e.keyCode&&u.id("sbm").click()}}),f("button",{id:"sbm",class:"submit-button"},{async click(){const e=u.id("users"),t=u.id("messages");if(t.style.visibility="hidden",0!==e.value.length){const n=u.id("resbox-details"),o=u.id("loading-gif");o.style.display="inline",n.style.display="block";const s=await fetch(`/api/user-search/tokens/${await h()}`,{method:"get",credentials:"include"}),r=await s.text(),i=await l(y({token:r,user:e.value}),"/api/users/");o.style.display="none",n.style.display="none";try{return function(e){const t=e.users,n=u.id("results-all");n.style.display="block",u.empty(n);const o=document.createElement("div");if(o.textContent="Search Results",n.appendChild(o),0===t.length)return o.innerHTML="No Results Found";u.empty(n);for(const e of t){const t=u.create("a"),o=u.create("button");o.textContent=e.user,t.appendChild(o),u.set(t,"data-user",e.user),u.set(t,"data-chat_id",e.chat_id),t.href=`/#/chat/${e.chat_id}`,o.className="resbtn",n.appendChild(t),t.style.textDecoration="none",t.style.color="#000",t.style.display="block"}}(await i.json())}catch(e){return t.style.visibility="visible",t.innerHTML="An error occured on our end..please try again",console.warn(e)}}}},"Search"),f("div",{id:"errmsgs"})]),O=f("div",{class:"results",id:"res"},null,null,null,null,[f("div",{id:"resbox-details",style:{"margin-top":"20px"}},null,null,null,null,[f("img",{id:"loading-gif",src:"/static/loading.gif"})])]),D=f("div",{class:"main"},null,null,null,null,[T,O,f("div",{id:"results-all"}),f("div",{id:"prev-chats"})]),H=f("div",{class:"box-s"},null,null,async(e,t)=>{let n;if(e.length>1)return console.log("Unusable args"),location.hash=`/u/${e[0]}`;const o=await g();if(!o)return console.log("Not Logged In"),location.hash="/";if(0===e.length)return location.hash=`/u/${o}`;if(o!==(n=e[0]))return location.hash=location.hash.replace(n,o);const s=t.root;u.empty(s),s.textContent="Loading"},async(e,t)=>{document.title=`${e[0]} - WebMsg`;const n=await l(`user=${encodeURIComponent(await g())}`,"/api/chat_ids/"),o=await n.json(),s=u.id("prev-chats");s.innerHTML="<div>Your Previous Chats</div>";const r=o.previous_chats;if(0===r.length)return s.innerHTML="No previous chats Found";for(const e of r){const t=u.create("div"),n=u.create("button");n.textContent=e.user,t.appendChild(n),u.set(t,"data-user",e.user),u.set(t,"data-chat_id",e.chat_id),n.onclick=(()=>{location.href=`${window.location.protocol}//${location.host}/#/chat/${e.chat_id}`}),n.className="resbtn",s.appendChild(t)}await t._dataWebsocket()},[D],"/u/");let E,P,I,N,U;const B={iceServers:[{urls:"stun:stun.l.google.com:19302"}]},W={websockets:[],chatWith:null,_functions:{}};function F(e){P instanceof WebSocket&&("string"==typeof e?P.send(e):a(e)&&P.send(s(e)))}function q(){const e=u.id("start_chat");e&&(u.empty(e),e.remove()),F("ping"),F({sendTo:U,isOfferer:!!N})}const K=async({candidate:e},t)=>{e&&await F({sendTo:t,rtcData:{candidate:e}})};function z(e){const t=e.data;document.body.innerHTML+=`<div>Message From:${W.chatWith}->${t}</div>`}async function V(e){if(e){(E=new RTCPeerConnection(B)).onicecandidate=(e=>K(e,U)),I=E.createDataChannel(+new Date),console.log("new Data Channel",I),I.onmessage=(e=>(function(e){"__ping__"===e.data&&(I.onmessage=z)})(e));const e=await E.createOffer();await E.setLocalDescription(e),F({rtcData:E.localDescription,sendTo:U})}}const Y=async(e,t)=>{const n=e.data;if("pong"===n)return;if("ping"===n)return F("ping");const o=JSON.parse(n);console.log(o);const{checkOfferer:s,set_role:r,rtcData:i,sendTo:a}=o;return t=t||a,s?F({sendTo:t,isOfferer:!!N}):r&&"boolean"!=typeof N?(N=r,await V(N)):void(i&&await async function(e,t){console.log(e);const{rtcData:n,sendTo:o}=e;t!==o&&console.log(t,o),"offer"===n.type?(void 0===E&&((E=new RTCPeerConnection(B)).onicecandidate=(e=>K(e,t)),E.ondatachannel=(e=>{(I=e.channel).onmessage=z,I.send("__ping__"),console.log("Created a Data Channel",e)})),await E.setRemoteDescription(n),await E.setLocalDescription(await E.createAnswer()),await F({rtcData:E.localDescription,sendTo:t})):"answer"===n.type?(console.log("--\x3e",E),await E.setRemoteDescription(n)):n.candidate&&await E.addIceCandidate(n.candidate)}(o,t))};const G=f("div",{id:"main-chat-box",class:"box-s"},null,null,async(e,t)=>{let n;return await g()?e?1<e.length?(console.log("Unusable Args"),n=e[0],location.hash=`/chat/${n}`):1>e.length?await t.pushStatus(500):void 0:await t.pushStatus(500):(console.log("Not Logged In"),location.hash="/")},async(e,t)=>{const n=e[0],o=await(async e=>{const t=await l(y({chat_id:e}),"/api/validate-chat/"),n=await t.json();return!n.hasOwnProperty("error")&&n})(n);if(!o)return t.pushStatus(500);U=o.chat_with,W.chatWith=U,(P=await(async e=>{const t=await e._dataWebsocket(),n=W.websockets;return n&&(n.forEach(e=>{"function"==typeof e.close&&e.close()}),W.websockets.length=0),W.websockets.push(t),t})(t)).onmessage=Y;const s=await(async e=>{const t=await l(y({user:e}),"/api/get-userstats/");return"online"===(await t.json()).status})(U);console.log(s),s?await(console.log("Attempting to start a webrtc connection..."),void q()):await function(e,t){const n=u.id("main-chat-box"),o=f("div",{id:"start_chat",style:{height:"20%","overflow-wrap":"break-word","background-color":"#fff",width:"40%",display:"block",position:"absolute",margin:"auto",top:"0",left:"0",right:"0",bottom:"0",border:"2px solid #e3e3e3","border-radius":"15px","box-shadow":"2px 2px 2px 2px #e3e3f0","text-align":"center","flex-wrap":"wrap","align-items":"center",padding:"8px","justify-content":"center"}},null,null,null,null,[f("div",{style:{"font-weight":"bold"}},null,`Start Chat Session with ${e}`),f("div",null,null,"No ongoing chat session detected. Press the button to start a session"),f("button",{style:{"border-radius":"5px"},class:"resbtn"},{click:q},"Start")]);t.render(o,n)}(U,t)},[f("div",{class:"main"},null,null,null,null,[f("div",{id:"results-all"}),f("div",{class:"message-info"})])],"/chat/",function(){console.log("Unmounting"),W.websockets.forEach(e=>{"function"==typeof e.close&&e.close()});for(const e of Object.keys(W._functions))W._functions[e]=o;Object.keys(W).forEach(e=>{delete W[e]}),W.websockets=[],W._functions={},W.chatWith=null}),J=()=>{if(window.indexedDB){class e{constructor(e="WebCache",t="KeyStore"){this.storeName=t,this._dbase=new Promise((n,o)=>{const s=indexedDB.open(e,1);s.onerror=(()=>{n(null)}),s.onsuccess=(()=>{n(s.result)}),s.onupgradeneeded=(()=>{s.result.createObjectStore(t)})})}__IDBAct__(e,t){return this._dbase.then(n=>new Promise((o,s)=>{const r=n.transaction(this.storeName,e);r.oncomplete=(()=>o()),r.onabort=r.onerror=(()=>s()),t(r.objectStore(this.storeName))})).catch(e=>console.log(e)||null)}}let t;const n=()=>t||new e;window.$get=((e,t=n())=>{let o;return t.__IDBAct__("readonly",t=>{o=t.get(e)}).then(()=>o.result).catch(e=>console.log(e)||null)}),window.$set=((e,t,o=n())=>{try{return o.__IDBAct__("readwrite",n=>{n.put(t,e)})}catch(e){return null}}),window.$del=((e,t=n())=>{try{t.__IDBAct__("readwrite",t=>{t.delete(e)})}catch(e){return null}}),window.$__clear__=((e=n())=>{try{return console.warn("clearing Store:",e),e.__IDBAct__("readwrite",e=>{e.clear()})}catch(e){return e}}),window.$keys=((e=n())=>{const t=[];return e.__IDBAct__("readonly",e=>{(e.openKeyCursor||e.openCursor).call(e).onsuccess=function(){this.result&&(t.push(this.result.key),this.result.continue())}}).then(()=>t).catch(e=>null)})}else{const e=async()=>null;window.$get=window.$set=window.$keys=window.$__clear__=window.$del=e}};(async()=>{J();try{(()=>{if(window.Notification){if("undefined"==typeof firebase)throw new Error("hosting/init-error: Firebase SDK not detected. You must include it before /__/firebase/init.js");firebase.initializeApp({apiKey:"AIzaSyCrdjBktQNWizVmfjK50I7BGsIQcNFmKcI",databaseURL:"https://webmsg-py.firebaseio.com",storageBucket:"webmsg-py.appspot.com",authDomain:"webmsg-py.firebaseapp.com",messagingSenderId:"193257233140",projectId:"webmsg-py"})}})()}catch(e){console.log(e)}const e=new class{constructor(e=u.id("app-root")||u.q("body")){this.root=e,this.unMountFn=(()=>{}),this.routeMap={},this.__socket=null,this.statusHandler={404:{element:"div",attrs:{style:m},textContent:"The Page you are requesting was not found",children:[b]},500:{element:"div",attrs:{style:m},textContent:"An Error Occured while trying to process your request",children:[b]}},this.routes=[],this.routeParser=(e=>{let t,n;if("#"===e[0])t=e.substr(1);else try{t=(n=new URL(e)).hash.substr(1)}catch(e){t="/",console.log(e)}return 0===t.length?"/":t}),window.onhashchange=(()=>{this.routeChange()})}load(e){window.location.href=`${window.location.protocol}//${window.location.host}/#/${e}`}_dataWebsocket(e="/_/data/"){return new Promise(t=>{if(this.__socket&&this.__socket.readyState!==this.__socket.CLOSED&&this.__socket.readyState!==this.__socket.CLOSING)t(this.__socket);else{const n=`${"https:"===window.location.protocol?"wss://":"ws://"}${window.location.host}${e}`,o=new WebSocket(n);this.__socket=o,o.onopen=(()=>{t(o)})}})}startLoad(){this.routeChange()}pushStatus(e){return this.statusHandler[e]?this.render(this.statusHandler[e],this.root,!0):this.render(this.statusHandler[404])}isValidRoute(e){if(this.routes.includes(e))return{res:!0,args:null,_fRoute:e};try{const t=e.split("/").filter(e=>e),n=`/${t[0]}/`;return this.routes.includes(n)?{res:!0,args:t.slice(1),_fRoute:n}:{res:!1}}catch(e){return console.log(e),{res:!1}}}routeChange(){const e=this.routeParser(location.href),{res:t,args:n,_fRoute:o}=this.isValidRoute(e);t?(console.log("rendering"),this.render(this.routeMap[o],this.root,!0,n)):this.render(this.statusHandler[404],this.root,!0,n)}async render(e,t,n=!1,o=null){const{element:s,attrs:r,beforeRender:a,onrender:l,textContent:h,onUnmount:p,events:g,children:y,isRoute:f}=e;f&&this.unMountFn(),c(a)&&(d(a)?await a(o,this):a(o,this));const w=u.create(s,r,i);h&&(w.textContent=h);for(const e of Object.keys(g||{}))w.addEventListener(e,g[e]);for(const e of y||[])this.render(e,w);return n&&u.empty(t),t.appendChild(w),f&&(this.unMountFn=p||(()=>{})),c(l)&&(d(l)?await l(o,this):l(o,this)),w}registerRoute(e,t=!1){if(!e.route||!e.element||"/"!==e.route[0])throw new Error("invalid values");if(!t){this.routes.push(e.route);const{attrs:t,beforeRender:n,children:o,element:s,events:r,hasRouteArgs:i,onUnmount:a,onrender:l,route:c,textContent:d}=e;return this.routeMap[c]={element:s,beforeRender:n,onrender:l,hasRouteArgs:i,attrs:t,textContent:d,events:r,children:o,onUnmount:a,isRoute:!0}}{const t=e.status;this.statusHandler[t]=e}}}(u.id("app-root")||document.body);e.registerRoute(M),e.registerRoute(H),e.registerRoute(G),e.registerRoute(Object.assign({},{route:"/_500/"},e.statusHandler[500])),e.startLoad()})()}]);