(async()=>{const e=`${("https:"===window.location.protocol?"wss://":"ws://")+window.location.host}/@/messenger/`;let t,s;if("function"==typeof window.Notification){try{t=firebase.messaging(),await t.requestPermission(),t.usePublicVapidKey("BGhv7XYjPBkpVoOEPbq2E19Is1ti_MYfboTDazKE0jgxPENxDqe0-U2p1OKEEgG4JH4Ycl8Wbxdv-UrrP_LcLmw"),await t.getToken();const e=async()=>{const e=await t.getToken();console.log("Token refreshed."),console.log(e),await fetch("/@/notify/",{method:"post",headers:{"content-type":"application/x-www-form-urlencoded"},body:`token=${encodeURIComponent(e)}`})};await e(),t.onTokenRefresh(e)}catch(e){console.log("Permission-Denied")}function a(t,s=new WebSocket(e)){const a=n.create("div"),i=n.create("div"),o=n.create("div"),c=n.create("div"),l=n.create("span"),d=n.create("span"),r=n.create("input"),p=t.sender,m=t.messageContent,g=t.hasImage;if(n.set(r,"class","notification-reply-bar"),n.set(a,"class","notification-box"),n.set(i,"class","notification-sender"),n.set(o,"class","notification-text"),n.set(c,"class","notification-action-box"),n.set(l,"class","notification-action-button"),n.set(d,"class","notification-action-button"),a.appendChild(i),a.appendChild(o),a.appendChild(c),c.appendChild(l),c.appendChild(d),i.textContent=p,l.textContent=`Reply To ${p}`,d.textContent="Mark As Read",g){const e=new Image;e.src="/static/attachment.svg",o.innerHTML="",o.appendChild(e)}else o.textContent=m;let u;document.body.appendChild(a),l.onclick=(()=>{clearTimeout(u),l.replaceWith(r),r.onkeydown=(e=>{if(13===e.keyCode&&r.value.replace(/\s/g,"").length>0){const e=(new Date).getTime(),t=r.value,n={user:p,message:t,typing:!1,media:null,stamp:e};s.send(JSON.stringify(n)),r.value="",a.remove()}})}),d.onclick=(()=>{const e={user:p,message:null,read:{id:t.msgid},stamp:(new Date).getTime(),rstamp:(new Date).getTime()};s.send(JSON.stringify(e)),a.remove()}),o.onclick=i.onclick=(()=>{h(p)}),setTimeout(()=>{a.style.marginTop="15px",u=setTimeout(()=>{a.remove()},4e3)},500)}"granted"===Notification.permission&&(console.log("Granted Notification Perm"),t.onMessage(e=>{const t=e.data;console.log("Creating Notification UI"),"function"==typeof s?t.sender!==s()&&a(t):a(t)}))}(new Image).src="/static/attachment.svg",(new Image).src="/static/close.svg";const n={id:e=>document.getElementById(e),className:(e,t=!0)=>{const s=Array.from(document.getElementsByClassName(e));return t?s[0]:s},create:e=>document.createElement(e),set:(e,t,s)=>e.setAttribute(t,s)},i=n.id("users"),o=n.id("sbm"),c=document.querySelector("meta[name='nonce']").getAttribute("content"),l=n.id("loading-gif"),d=n.id("messages"),r=n.id("results-all"),p=n.id("resbox-details"),m=n.id("res"),g=n.id("username_meta").getAttribute("content"),u=n.id("searchbox");async function h(t){s=(()=>t);const a=await fetch("/api/chatid/",{method:"POST",credentials:"include",body:y({side_a:g,side_b:t}),headers:{"content-type":"application/x-www-form-urlencoded"}});if(200!==a.status)return document.body.innerHTML="An error Occured..please reload the page";n.__chatID__=await a.text(),r.innerHTML="",m.style.display="none",u.style.display="none";const i=n.create("div"),o=n.create("div"),c=n.create("div"),l=n.create("div"),d=n.create("input"),p=n.create("img"),C=n.create("span"),v=n.create("div"),b=n.create("span"),k=n.create("img"),x=n.create("div"),T=n.create("div"),_=n.create("img");n.set(v,"data-stat","closed"),n.set(v,"class","menu-details"),n.set(b,"class","menubox"),n.set(d,"type","text"),n.set(d,"placeholder","Type a Message"),n.set(i,"class","chat_box_wrap"),n.set(o,"class","chat_box"),n.set(c,"class","chat_head"),n.set(l,"class","chat_body"),n.set(d,"class","chat_inp"),n.set(p,"class","context"),n.set(x,"class","img-button-holder"),n.set(T,"class","img-button-holder"),n.set(_,"title","Attach a File"),n.set(k,"title","Close this Chat"),n.set(d,"data-user",t),x.appendChild(k),T.appendChild(_),v.appendChild(x),v.appendChild(T),c.appendChild(b),c.appendChild(C),o.appendChild(c),o.appendChild(v),o.appendChild(l),o.appendChild(d),o.appendChild(p),i.appendChild(o),r.appendChild(i),k.onclick=(()=>{n.id("message-info").innerHTML="",n.id("message-info").style.opacity="0.0",r.innerHTML="",r.style.display="none",u.style.display="block",m.style.display="block"}),b.innerHTML="&#9776;",C.textContent=t,k.src="/static/close.svg",_.src="/static/attachment.svg",k.style.cursor="pointer",_.style.cursor="pointer";const L=new WebSocket(e);async function D(e,t){async function s(e,t,s,a,i,o,c,l,d=null){let r;const p=n.create("div");if(s===g?(r="msg_sent",p.style.marginLeft="auto"):(r="msg_recieved",p.style.marginRight="auto"),n.set(p,"class",`msg ${r}`),d){n.set(p,"data-media",d);const e=new Image;e.src="/static/attachment.svg",p.appendChild(e),p.style.fontSize="12px",p.appendChild+="Media Message"}else n.set(p,"data-media",null),p.textContent=t;let m;n.set(p,"data-sender",s),n.set(p,"data-receiver",a),n.set(p,"data-stamp",i),n.set(p,"data-msgid",o),n.set(p,"data-read",c),n.set(p,"data-rstamp",l),e.appendChild(p),e.scrollTop=e.scrollHeight,p.onclick=function(){!function(e){const t=e.dataset,s=t.sender,a=parseInt(t.stamp),i=t.read,o=parseInt(t.rstamp),c=t.media,l=n.id("message-info");l.innerHTML="",l.style.opacity="1";const d=n.create("div");n.set(d,"class","message-close"),d.innerHTML="Close";const r=n.create("div");r.style.transition="0.3s ease-in-out",l.appendChild(d),l.appendChild(r),d.onclick=(()=>{r.style.opacity="0",r.style.height="0px",l.style.opacity="0",l.innerHTML=""});const p=n.create("div"),m=n.create("div"),u=n.create("div"),h=n.create("div"),y=n.create("div"),C=n.create("div");if(n.set(p,"class","message-info-key"),n.set(p,"data-slide","out"),n.set(m,"class","message-info-value"),n.set(u,"class","message-info-key"),n.set(u,"data-slide","out"),n.set(h,"class","message-info-value"),n.set(y,"class","message-info-key"),n.set(y,"data-slide","out"),n.set(C,"class","message-info-value"),p.onclick=(()=>{w(m),f(p)}),m.onclick=(()=>{w(p),f(m)}),u.onclick=(()=>{w(h),f(u)}),h.onclick=(()=>{w(u),f(h)}),y.onclick=(()=>{w(C),f(y)}),C.onclick=(()=>{w(y),f(C)}),p.textContent="Sender",m.textContent=s+(s===g?"(You)":""),y.textContent="Time",C.textContent=new Date(a).toLocaleString(),u.textContent="Read-Status",h.textContent="true"===i?`Read (${isNaN(o)?"N/A":new Date(o).toLocaleString()})`:"Sent",s!==g&&(u.style.display="none",h.style.display="none"),"null"!==c){const e=n.create("div"),t=n.create("div");n.set(e,"class","message-info-key"),n.set(t,"class","message-info-value"),e.textContent="Media Message",t.innerHTML="Click To Open Media Preview",t.style.cursor="pointer",n.set(t,"data-media",c),w(t),t.onclick=(()=>{const e=t.dataset,s=new Image;s.src=e.media,r.innerHTML="";const a=n.create("a");r.appendChild(s),r.appendChild(a),a.style.color="black",a.style.textDecoration="none",a.target="__blank",a.style.display="block",a.innerHTML="Click To Open Image In A New Tab",a.href=e.media,s.style.width="160px",s.style.height="100px"}),r.appendChild(e),r.appendChild(t)}l.style.display="block",r.appendChild(p),r.appendChild(m),r.appendChild(y),r.appendChild(C),r.appendChild(u),r.appendChild(h),console.log(t)}(this)},(m=await $get(n.__chatID__))?(console.log("Cache HIT"),m[o]||(console.log("[indexedDB]Adding new entry:",o),m[o]={message:t,sender:s,stamp:i,read:c,media:!!d||null,mediaURL:d,rstamp:l,receiver:a},await $set(n.__chatID__,m))):console.log("[indexedDB]Cache MISS")}if(t.typing)return C.style.color="green";if(C.style.color="#fff",t.fetch){console.log("FETCHED DETAILS");const s=t.data;if(t.full_fetch)console.log("[indexedDB]Setting Full Cache to indexedDB:",s),await $set(n.__chatID__,s);else{const e=await $get(n.__chatID__),t=Object.assign({},e,s);await $set(n.__chatID__,t)}const a=t.fetched_from;for(let t=0;t<Object.keys(s).length;t++){let n;const i=s[n=isNaN(a)?t:t+a];i&&(i.msgid=n,D(e,i))}}let a,i,o,c,l,d,r;if((t.media||t.message)&&!t.read&&!t.rstamp&&t.sender!==g){const e={user:t.sender,message:null,read:{id:t.msgid},stamp:(new Date).getTime(),rstamp:(new Date).getTime()};L.send(JSON.stringify(e))}if(t.message)return a=t.message,i=t.sender,o=t.receiver,c=t.stamp,l=t.read,d=t.rstamp,s(e,a,i,o,c,r=t.msgid,l,d);if(t.update){const e=t.msgid,s=document.querySelector(`div[data-msgid='${e}']`);n.set(s,"data-read",t.update.read),n.set(s,"data-rstamp",t.update.rstamp)}if(t.media){const a=t.mediaURL;i=t.sender,o=t.receiver,l=t.read,d=t.rstamp,s(e,null,i,o,c=t.stamp,r=t.msgid,l,d,a)}}L.onmessage=(e=>{const t=e.data;try{const s=JSON.parse(t);if(s.hasOwnProperty("error"))return console.log("prop-error",s),l.innerHTML+="<br>An error occured Please reload the page";D(l,s)}catch(e){console.log(e,"ERROR in parsing message"),l.innerHTML+="<br>An error occured Please reload the page"}}),L.onopen=(()=>{(async function(e,t,s){const a=await $get(n.__chatID__);let i;if(a){const n=Object.keys(a).length;console.log("Checking For Updated Data"),i={stamp:(new Date).getTime(),message:null,user:t,fetch_messages:!0,fetch_from:n-1};for(let e=0;e<n;e++){const t=a[e];t&&(t.msgid=e,console.log(`Parsing msgid: ${e} from cache`),D(s,t))}return e.send(JSON.stringify(i)),!0}console.log("Fetching New"),i={stamp:(new Date).getTime(),message:null,user:t,fetch_messages:!0},e.send(JSON.stringify(i))})(L,t,l),console.log("Socket Opened")}),L.onclose=(()=>{h(s()),l.innerHTML+="<br>Connection to server was lost. Please Reload the page"}),_.onclick=(()=>{const e=n.create("input");n.set(e,"accept","image/*"),n.set(e,"type","file"),e.addEventListener("change",()=>{const s=e.files[0],a=new FileReader;a.onload=(e=>{const n=a.result,i=new Image;i.src=n,i.onload=(async()=>{const e=await async function(e,t,s){const a=document.createElement("canvas");if(void 0===e.naturalWidth&&void 0===e.naturalHeight)return console.log(e,"no natural width"),null;a.width=e.naturalWidth,a.height=e.naturalHeight,a.getContext("2d").drawImage(e,0,0);const n=a.toDataURL(s,t/100),i=await fetch(n);return await i.arrayBuffer()}(i,65,s.type),a=await fetch("/@/binary/",{credentials:"include",method:"post",headers:{"x-file-name":s.name},body:e}),n={media:(await a.json()).url,message:null,user:t,stamp:(new Date).getTime()};L.send(JSON.stringify(n))})}),a.readAsDataURL(s)}),e.click()}),b.onclick=(()=>{if("closed"!=v.getAttribute("data-stat"))return n.set(v,"data-stat","closed"),v.style.marginLeft="-100px";n.set(v,"data-stat","opened"),v.style.marginLeft="0px"}),d.onkeydown=function(e){if(13===e.keyCode&&this.value.replace(/\s/g,"").length>0){const e=(new Date).getTime(),t=d.value,s={user:this.getAttribute("data-user"),message:t,typing:!1,media:null,stamp:e};L.send(JSON.stringify(s)),d.value=""}}}l.oncontextmenu=(e=>{e.preventDefault()}),i.addEventListener("keydown",e=>{13===e.keyCode&&o.click()});const y=e=>`${Object.keys(e).map(t=>`${encodeURIComponent(t)}=${encodeURIComponent(e[t])}`).join("&")}`;function f(e){e.style.overflow="hidden",e.style.padding="0px",e.style.opacity=0,e.style.height="0",e.style.border="none",e.style.width="0"}function w(e){e.style.padding="5px",e.style.opacity=1,e.style.height="auto",e.style.width="auto",e.style.border="2px solid #e3e3e3",e.style.overflow="visible"}o.onclick=(async()=>{if(d.style.visibility="hidden",0!=i.value.length){p.style.display="block",l.style.display="inline";const e=await fetch(`/api/user-search/tokens/${c}`,{method:"get",credentials:"include"}),t=await e.text(),s=await fetch("/api/users/",{credentials:"include",method:"post",headers:{"content-type":"application/x-www-form-urlencoded"},body:y({token:t,user:i.value})});l.style.display="none",p.style.display="none";try{return function(e){const t=e.users;if(r.innerHTML="",r.style.display="block",0===t.length)return r.innerHTML="No Results Found";for(const e of t){const t=document.createElement("div"),s=document.createElement("button");s.innerHTML=e,t.appendChild(s),n.set(t,"data-result",e),s.className="resbtn",r.appendChild(t),t.onclick=function(){h(this.getAttribute("data-result")),t.onclick=(()=>{})}}}(await s.json())}catch(e){return console.warn(e),d.style.visibility="visible",d.innerHTML="An error occured on our end..please try again"}}})})();